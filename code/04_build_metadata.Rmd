---
title: "ADVANZ_Metadata"
author: "Carlos Blázquez Bondia"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)

```

## Load and merge metadata files. 

Metadata consists on two tables. ne with sample information, coming a merge between two tables, the one with the samples collected in HC and the other ones from IrsiCaixa. The other table contains all the relevant clinical and demographic information along with group data

```{r read_tables, warning=F, message=F}


upload_bucket <- "mistral-wp6-advanz4/data_transfer/metagenome/"

# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","Var_names.csv"), bucket = upload_bucket)
variables_selected <- read.csv(here::here("Metadata","MetadataManagement","Var_names.csv"), header=T, encoding = "UTF-8") %>%
  dplyr::filter(selected == "YES") 


# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","metadata_select.csv"), bucket = upload_bucket)
mySampleData<-here::here("Metadata","MetadataManagement","metadata_select.csv")%>%
  read.csv(.) %>%
  relocate(CODE,Week,ExtractionDate,PatCode) %>%
  mutate(ExtractionDate = as.character(format(as.Date(ExtractionDate), "%d%b%Y"))) %>%
  select(-c(DateDiff))

# here::here("Metadata","MetadataManagement","Export.xlsx") %>% 
#   readxl::read_excel() %>% 
#   write.csv(., "Metadata/MetadataManagement/Clinical_Table.csv") # An excel file may bring problems due to format, encoding and sys.locale. This is to create a csv which should be read more universally.


# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","Clinical_Table.csv"), bucket = upload_bucket)


myClinicalData<-here::here("Metadata","MetadataManagement","Clinical_table.csv") %>%
  read.csv() %>%
  # setNames(stringi::stri_enc_detect(colnames(.))) %>% 
  select(variables_selected$VarName) %>%
  mutate(PatCode = gsub("-","",PatCode)) %>%
  mutate(group = case_when(Treat == "ABC+3TC+DGT" ~ "DTG",
                           Treat == "ABC+3TC+DRV+RTV" ~ "DRV/r")) 

myMergedMetadata <- myClinicalData %>%
  right_join(mySampleData, ., by="PatCode") %>%
  # filter(Selected_For_Sequencing == "Yes")  %>%

  relocate(PatCode, Week,  group) %>%
  arrange(PatCode, Week) %>%
  dplyr::rename(!!set_names(variables_selected$VarName, variables_selected$NewName)) %>%
  dplyr::rename(
                record_id = pat_code, 
                time_point = Week
         ) 
      
# glimpse(myMergedMetadata)
```



# Adding Lab and Demographic results (Lymphocytes and inflammation markers)
Raw extracted data had a "melted" structure, so we may need to change it to wide format

```{r read_and_process_Lab_Results, warning=F, message=F}

vars=c("CD4 value","CD8 value", "4+38+DR+","8+38+DR+", "PCR", "IL-6", "TNF-a", "sCD14","HIV Viral load [central]", "CMV Viral Load")
names(vars) <- c("CD4","CD8", "CD4_CD38_DR","CD8_CD38_DR", "CRP", "IL6", "TNFa", "sCD14", "HIV_VL", "CMV_VL")

Sys.setlocale("LC_TIME", "English")


# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","LabData.xls"), bucket = upload_bucket)
MetadataLab <-
  here::here("Metadata", "MetadataManagement", "LabData.xls") %>%
  readxl::read_excel() %>%
  filter(ParamName %in% vars & PatCode != "TMP??-000") %>%
  dplyr::select(
    record_id = PatCode,
    time_point = Week,
    method = ParamName,
    value = Result,
    units = Units,
    result_date = LabDt
  ) %>%
  dplyr::filter(method %in% vars) %>%
  dplyr::mutate(
    method = recode(
      method,
     `CD4 value` = "CD4",
     `CD8 value` = "CD8",
     `4+38+DR+`= "CD4_CD38_DR",
     `8+38+DR+` = "CD8_CD38_DR",
      PCR = "CRP",
      `IL-6` = "IL6",
      `TNF-a` = "TNFa",
      sCD14 = "sCD14",
     `HIV Viral load [central]` = "HIV_VL",
     `CMV Viral Load` = "CMV_VL"
     ),
    record_id = str_remove_all(record_id,"-"), result_date = as.character(result_date))








  
  # pivot_wider(id_cols = c("PatCode", "Week"),names_from="ParamName", values_from = c("Result")) %>%
  # dplyr::select(record_id = PatCode,
  #               time_point = Week,
  #               CD4 = `CD4 value`,
  #               CD8 = `CD8 value`,
  #               CD8_CD38_DR = `8+38+DR+`,
  #               CRP = PCR,
  #               IL6 = `IL-6`,
  #               TNFa = `TNF-a`,
  #               sCD14 = sCD14,
  #               result_date = LabDt
  #               ) %>%
  # mutate(time_point = as.numeric(time_point)) %>%
  # mutate(record_id = gsub("-","",record_id)) %>%
  # left_join(myMergedMetadata, ., by=c("record_id","time_point"), all=T) 







```


Lab data for week 96 came later, so we'll have to format it and merge it with previous lab data before incorporating it into the main metadata.

```{r, add_data_96, warning=F, message=F}

# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","LabData_96.xls"), bucket = upload_bucket)
dat_96 <- 
  here::here("Metadata","MetadataManagement", "LabData_96.xls") %>% 
  readxl::read_excel(.) %>% 
  dplyr::select(sample = Muestra, 
                method = Metodo,
                value = Result,
                units = Unidades,
                result_date = `Fecha Validac.`) %>% 
  dplyr::mutate(record_id = stringr::str_extract(sample, "(?<=\\s4)([A-Z][0-9]*)(?=\\s)"),.after=1,
                method = dplyr::recode(method,
                                       `Interleucina 6 (IL-6), suero` = "IL6",
                                       `proteína C reactiva (PCR), suero` = "CRP",
                                       `Factor de necrosis tumoral alfa (TNF-alfa), suero` = "TNFa"),
                time_point = 96,
                result_date = as.character(lubridate::as_date(result_date))) %>% 
  dplyr::select(-sample) %>% 
  filter(method != "CRP")



# dat_96 %>% 
#   pull(sample) %>% 
#   stringr::str_extract_all(., "(?<=\\s4)([A-Z][0-9]*)(?=\\s)")

```



```{r add_reworked_CRP, warning=F, message=F}


# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","CRP_updated.csv"), bucket = upload_bucket)
new_crp_96 <- here::here("Metadata","MetadataManagement", "CRP_updated.csv") %>% 
  read.csv(., sep=";", header = T) %>% 
  dplyr::select(sample = Muestra, value = Result, units = Unidades, result_date = Fecha.Validac.) %>% 
  dplyr::mutate(time_point = 96,
                record_id = str_extract(sample,"(?<=\\s4)[A-Z][0-9]*(?=\\s)"),
                method = "CRP",
                result_date = 
  lubridate::as_date(strptime(result_date, format = "%d/%m/%Y %H:%M")) %>% as.character()) %>% 
  dplyr::select(-sample) %>% 
  dplyr::relocate(colnames(dat_96)) %>% 
  rbind(., dat_96, by = c("record_id")) %>% 
  mutate(value = na_if(value, "<2")) %>% 
  arrange(record_id) 


```



```{r add_sCD14_sCD163, message = F, warning = F}
# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","LabData_96_sCD14.xls"), bucket = upload_bucket)
sCD14_96 <- 
  here::here("Metadata", "MetadataManagement", "LabData_96_sCD14.xls") %>% 
  readxl::read_excel(.,) %>% 
  dplyr::mutate(record_id = str_extract(Muestra, "(?<=4)[A-Z][0-9]*"),
                method = str_extract(Metodo, "(?:sCD[0-9]*)"),
                result_date = lubridate::as_date(`Fecha Validac.`),
                time_point = 96) %>% 
  dplyr::select(record_id, time_point, method, value = Result, units = Unidades, result_date) %>% 
  rbind(., new_crp_96) %>% 
  arrange(record_id)

```



```{r merge_lab_results }
clin_meta <- rbind(MetadataLab, sCD14_96) %>% 
  dplyr::mutate(time_point = as.numeric(time_point)) %>% 
  dplyr::filter(!is.na(time_point)) %>% 
  # dplyr::filter(time_point %in% c(0,24,48,96)) %>% 
  pivot_wider(id_cols = c("record_id","time_point"), values_from = c("value", "units", "result_date"), names_from = "method") %>% 
  arrange(record_id, time_point) %>% 
  setNames(str_remove_all(colnames(.), "value_")) 
```


```{r merge_lab_demographic, message = F, warning=F}


# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","Vital.xlsx"), bucket = upload_bucket)
MetadataLabDem<- here::here("Metadata","MetadataManagement","Vital.xlsx") %>%
  readxl::read_excel() %>%
  filter(PatCode != "TMP??-000") %>%
  pivot_wider(id_cols = c("PatCode", "Week"),names_from="ParamName", values_from = "Result") %>%
  dplyr::rename(record_id = PatCode,
         time_point = Week) %>%
  mutate(time_point = as.numeric(time_point),
         record_id = gsub("-","",record_id)) %>%
  full_join(., clin_meta ,by=c("record_id","time_point"), all.x = T) %>%
  right_join(., myMergedMetadata, by = c("record_id", "time_point")) %>% 
  relocate(record_id, time_point, group, names(vars),Weight, Height, BMI, SBP, DBP)
 
dim(MetadataLabDem) 

```

Now the metadata is almost complete. We need now to identify each sample so it can be quickly referenced in LIMS. \ 
\ 
1/3/2022: 
\ 
We'll add the variables suggested in the study design, separating the patients in thresholds of T-cell increase and absolute number at weeks 48 and 96. A total of 8 variables were added: \ 

*   **(CD4/CD8)diff(48/96)** - Increase of CD4/CD8 between weeks 48/96 and 0. Factor of two levels searating **patients** who had an increase higher or lower than 50 cells/ul. Patients with an increase equal or higher than 50 cells/ul were coded as ">50", while the ones lower than 50 were coded as "<50"

* **(CD4/CD8)after(48/96)** - Number of either CD4 or CD8 at week 48/96, **per patient**. S^eparated in three categories:
  *     **low** - <200 cells/ul at week 48/96
  *     **medium** - T-cell counts at week 48/96 equal to or between 200 and 500 cells/ul
  *       **high** - T-cell counts higher than 500 cell/ul


```{r LIMS_IDs, warning=F, message=F}


# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","Informacio_LIMS.xlsx"), bucket = upload_bucket)
metadata_final <-
  here::here("Metadata", "MetadataManagement","Informacio_LIMS.xlsx") %>%
  readxl::read_excel(sheet = "DNA") %>%
  select(SampleID = `Gemirsi DNA`, CODE = `Sample Name`) %>%
  mutate(CODE = str_remove_all(CODE, "_.*")) %>%
  left_join(MetadataLabDem, ., by = "CODE") %>%
  select(-CODE) %>%
  mutate(
    across(everything(), ~ str_replace_all(.x, "\\n", " ")),
    across(everything(), ~ str_replace_all(.x, "^[[.]]$|^$", NA_character_)), 
    across(everything(), ~ recode(.x,
                                  Si = "yes",
                                  No = "no",
                                  Yes = "yes"))) %>% 
    mutate(across(contains("date"), ~ as.Date(.x, "%d%b%Y"))
  ) %>%
  
  filter(!is.na(SampleID) & SampleID != "TMP??-000") %>%
  type_convert(col_types = cols()) 

metadata_final <- c(48,96) %>%
  set_names() %>%
  map( ~ {
    ids<- metadata_final %>%
      filter(time_point %in% c(0,.x)) %>%
      group_by(record_id) %>%
      summarise(n=n()) %>%
      filter(n == 2) %>%
      pull(record_id)  
    
    metadata_final %>% 
      filter(record_id %in% ids) %>%
      group_by(record_id) %>%
      arrange(time_point) %>%
      mutate(
      
      CD4diff = case_when(
        CD4[time_point == .x] - CD4[time_point == 0] >= 150 ~ "150_H",
        CD4[time_point == .x] - CD4[time_point == 0] < 150 ~ "150_L"),
      
      CD8diff = case_when(
        CD8[time_point == .x] - CD8[time_point == 0] >= 50 ~ "50_H",
        CD8[time_point == .x] - CD8[time_point == 0] < 50 ~ "50_L"),
      
      CD4after = case_when(
        CD4[time_point == .x]  < 200 ~ "low",
        CD4[time_point == .x]  >= 200 & CD4[time_point == .x] <= 500 ~ "mid",
        CD4[time_point == .x]  > 500 ~ "high"),
      
      CD8after = case_when(
        CD8[time_point == .x]  < 200 ~ "low",
        CD8[time_point == .x]  >= 200 & CD8[time_point == .x] <= 500 ~ "mid",
        CD8[time_point == .x]  > 500 ~ "high")) %>%
      
      select(record_id, CD4diff, CD8diff, CD4after,CD8after) %>%
      setNames(str_replace_all(colnames(.), "diff", paste("diff_",.x,sep=""))) %>%
      setNames(str_replace_all(colnames(.), "after", paste("after_",.x,sep=""))) %>%
      unique()

  }) %>%
  reduce(full_join, by="record_id") %>%
  full_join(metadata_final, bby="record_id") %>%
  # select(record_id,contains("diff"), contains("after")) %>%
  unique() %>%
  relocate(SampleID, record_id, time_point, group, names(vars), contains("diff"), contains("after")) %>%
    type_convert(col_types = cols())

  


```


# Reformat metadata

```{r reformat_metadata, warning = F, message = F}

metadata_final <- 
  metadata_final %>% 
  dplyr::mutate( ethnic_group = recode(
    ethnic_group,
    Hispano = "hispanic",
    Blanco = "caucassian",
    Negro = "black",
    Asiático = "asian",
    Desconocido = "unknown",
    Otro = "other"
  ),
  treatment = recode(
    treatment,
    `ABC+3TC+DGT` = "ABC+3TC+DTG"
  ),
  country = recode(
    country,
    UNKNOWN = "unknown",
    `ESPAÑA` = "Spain",
    `PERÚ` = "Peru",
    SENEGAL = "Senegal",
    ARGENTINO = "Argentina",
    ARGENTINA = "Argentina",
    ECUADOR = "Ecuador",
    COLOMBIA = "Colombia",
    RUMANIA = "Romania",
    VENEZOLANO = "Venezuela",
    MARRUECOS = "Morocco",
    VENEZUELA = "Venezuela",
    `GUINEA ECUATORIAL (BATA)` = "Equatorial_Guinea",
    BRASIL = "Brazil",
    CHINA = "China",
    PARAGUAY = "Paraguay",
    `ÁFRICA` = "Africa",
    `MÉJICO` = "Mexico",
    CAMERUN = "Cameroon",
    `CAMERÚN` = "Cameroon",
    HONDURAS = "Honduras",
    GANA = "Ghana",
    CUBA = "Cuba",
    `REPÚBLICA DOMINICANA` = "Dominican_Republic"
  ),
  gender = recode(
    gender,
    Hombre = "male",
    Mujer = "female"
  ),
  risk_group = recode(
    risk_group,
    `HTSX-No UDVP` = "hts",
    HTSX = "hts",
    `HMSX-No UDVP` = "msm",
    `BISX-No UDVP` = "msm",
    HMSX = "msm", 
    `HMSX-HTSX-No UDVP` = "msm",
    `Not Qualified` = "unknown",
    `HMSX-HTSX` = "msm",
    UDVP = "pwid"
  ),

  previous_liver_disease = recode(
    previous_liver_disease,
    `HEPATITIS VIRAL B SIN COMA HEPATICO, CRONICA SIN H. DELTA` = "HBV_chronic",
    `esteatosis hepática` = "fatty_liver",
    VHC = "VHC",
    `hepatitis aguda VHA` = "VHA_acute",
    `Hepatitis aguda VHB` = "VHB_acute",
    `Hepatitis crónica VHC genotipo 1b` = "VHC",
    `Infección crónica por VHC` = "VHC"
  ), 
  previous_kidney_disease = recode(
    previous_kidney_disease,
    `Insuficiencia renal` = "renal_insufficiency",
    LITIASIS = "lithiasis"
  ),
  center = recode(
    center,
    `Hospital Clínic` = "clinic",
    `Hospital Germnas Trias i Pujol, Barcelona` = "hgtp",
    `Hospital de Sant Pau, Barcelona` = "sant_pau",
    `Hospital de Bellvitge, L'Hospitalet` = "bellvitge",
    `Hospital Val d'Hebron, Barcelona` = "vall_hebron",
    `Hospital de Mataro, Barcelona` = "mataro"
  ),
  end_reason_48 = recode(
    end_reason_48,
    `No Premature Finalisation` = "followup_complete",
    `Lost to Follow-up` = "fail_to_follow_up",
    `Virological Failure` = "virological_failure",
    Safety = "safety_concerns",
    `Clinical Progression` = "clinical_progression",
    `Selection Criteria` = "Selection Criteria"
  ),
  end_reason_96 = recode(
    end_reason_96,
    `No Premature Finalisation` = "followup_complete",
    `Lost to Follow-up` = "fail_to_follow_up",
    `Virological Failure` = "virological_failure",
    Safety = "safety_concerns",
    `Clinical Progression` = "clinical_progression",
    `Selection Criteria` = "Selection Criteria"
  )
  

  ) %>%
  mutate(across(where(is.character), ~ na_if(.,"unknown"))) %>%
  arrange(record_id, time_point)


## Filter patients with <2 samples
# outpatients <- metadata_final %>%
#   select(SampleID, record_id) %>%
#   group_by(record_id) %>%
#   summarise(n=n()) %>%
#   filter(n<2) %>% 
#   pull(record_id)
# 



# 
# write.csv(colnames(metadata_final),file="Var_names.csv", quote=T)



```



```{r add_ADV_results, message= T, warning= T}

# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","Resultats_Real_Time.xlsx"), bucket = upload_bucket)
PCR <- here::here("Metadata", "MetadataManagement", "Resultats_Real_Time.xlsx") %>% 
  readxl::read_excel(., sheet = 1) %>% 
  setNames(c("SampleID", "test", "ct", "value", "unit", "kit")) %>% 
  pivot_wider(names_from = test, values_from = c(value, ct)) %>% 
  rename(ADV = value_ADV,
         ct_IC = ct_CI) %>% 
  select(!value_CI) %>% 
  mutate(ADV = round(ADV,4),
         ct_IC = na_if(ct_IC, "Undetermined"),
         ct_ADV = na_if(ct_ADV, "Undetermined")) %>% 
  mutate(ADV = as.numeric(ADV)) %>%
  filter(!is.na(ADV) & !is.na(ct_IC))


metadata_final <- 
  metadata_final %>% 
  left_join(PCR, by="SampleID") %>% 
  relocate(ADV, .after="sCD14")



```



We'll perform a final filtering in which we remove patients with 1 sample and it's not basal. We'll also take away patients C004 and E009 due to being wrongly selected for sequencing (did not meet exclusion criteria)

```{r further_filter, warning=F, message=FALSE}

singlesample <- 
  metadata_final %>% 
  dplyr::select(SampleID, record_id) %>% 
  group_by(record_id) %>% 
  filter(n()<2) %>% 
  pull(record_id)


filtered_counts <- 
  metadata_final %>% 
  dplyr::select(record_id, group) %>%
  dplyr::group_by(record_id) %>% 
  dplyr::filter(n()>1) %>% 
  unique() %>% 
  pull(group) %>% 
  table()




discarded_ids <- 
  metadata_final %>%
  filter(record_id %in% singlesample) %>%

  select(record_id,group,time_point) %>%
  filter(!time_point == 0) %>%
  pull(record_id)

metadata_final <- metadata_final %>% 
  filter(!record_id %in% c("C004", "E009")) %>%
  filter(!record_id %in% discarded_ids)  


metadata_final %>% 
  select(record_id, group) %>% 
  unique() %>% 
  group_by(group) %>% 
  summarise(n=n())


```


Finally, we add the clinical data (CRP, TNFa and IL6) which came late. We'll format it nicely and merge it with the final_meta




## Basic Analytics

Let's see how many patients were dropped and how it affects straification and group symmetry. We'll perform some analysis here to check the quality of the metadata, stratification and Followup

```{r plot_basal_followup, warning=FALSE, message=FALSE}

library(ggplot2)
library(compareGroups)
source(here::here("code","Followup_plot.R"))


myCompTable <- metadata_final %>% 
  select(record_id, 
         time_point,
         group,
         gender,
         age,
         ethnic_group,
         CD4_nadir) %>% 
  filter(time_point == 0) %>% 
  compareGroups(group ~ gender + age + ethnic_group + CD4_nadir ,., simplify = F) %>% createTable()

compareGroups::export2md(myCompTable, format="markdown",caption = paste("Group comparisons at basal","(group Ns may not match flowchart due to some patients having multiple samples but not at basal)", sep="\n")) 
sampleData<-here::here("Metadata","MetadataManagement","Informacio_LIMS.xlsx") %>%
  readxl::read_excel(sheet = 1) %>%
  select(record_id = CODIGO,
         time_point = Week,
         Date = `Extracción`) %>%
  mutate(record_id = sapply(strsplit(gsub("^4*","",record_id), "-"), "[[",1),
         Date = lubridate::as_date(Date, format="%d/%m/%Y"),
         time_point = ifelse(time_point == "Basal", 0,
                            gsub("^w*", "", time_point))) %>% 
  unique() 
  
p=Plot_FollowUp(data = sampleData, 
              patientColumn = "record_id",
              Dates = "Date",
              TimePoints = "time_point") 
p + scale_size_manual(values = c(size=2))



```

CD4 nadir in the DTG group is significantly higher than DRV (mean 44.4% higher). This may be problematic.



```{r Write_metadata}

# aws.s3::put_object(file =  here::here("Metadata","MetadataManagement","2022_10_05_clean_metadata_LIMS.csv"), bucket = upload_bucket)



metadata_final %>%
  readr::write_delim(
        file = here::here("Metadata",
            
            str_c(Sys.Date() %>% str_replace_all("-", "_"), "_clean_metadata_LIMS.csv")
        ), 
        delim = ",", quote = "all"
    )


aws.s3::put_object(file =  here::here(
  "Metadata",
  
  str_c(
    Sys.Date() %>% str_replace_all("-", "_"),
    "_clean_metadata_LIMS.csv"
  )
), bucket = upload_bucket)


```


```{r create_backup_DONT_TOUCH, echo=F, eval=F}
# bakDF<-data.frame(VarName = names(variables_selected), NewName = as.character(variables_selected))
# variables_redone<-here::here("Metadata","Clinical_Table.csv") %>%
#   read.csv() %>%
#   colnames() %>%
#   data.frame(VarName = .) %>%
#   left_join(.,bakDF, by="VarName") %>%
#   mutate(selected = ifelse(is.na(NewName),"NO","YES")) %>%
#   arrange(match(NewName, colnames(metadata_final)))
# write.csv(variables_redone, file=here::here("Metadata","variables_bak.csv"), row.names = F)

```
