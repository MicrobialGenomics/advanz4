---
title: "path function DA"
author: "Carlos Bl√°zquez Bondia"
date: '2022-10-11'
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

In this document we are going to explore wether there are significant differences in specific pathways between groups and other variables. The startup, data input and first processing is the same as in the section path Function Exploratio and it will be hidden in this document for clarity's sake, as the specific code will be long.


```{r setup, warning = F, message=F, echo=F}
library(metar)
library(tidyverse)
library(vegan)
library(RColorBrewer)
source(here::here("code", "Paired_wilcox_NA_Handler.R"))
source(here::here("code","LMM.R"))
source(here::here("code","myFunctions.R"))
```



```{r load_metadata_vars,echo = F, eval=T, include=F}


mymre <- aws.s3::s3readRDS("s3://mistral-wp6-advanz4/metagenome/WMGS/MREObject.rds") ### Check consistency between mre.rds(local and S3). You are reading s3 file, here, but in 200_ you are using local
# metadata <- metar::get_metadata(mymre)@metadata_df

metadata <- here::here("Metadata", "2022_09_29_clean_metadata_LIMS.csv") %>% 
  read.csv() %>% 
  column_to_rownames("SampleID") %>% 
  mutate(SampleID = rownames(.))

mymre@metadata@categorical_vals <-  
  here::here("Metadata","CategoricalVariables.txt") %>%
  read.table(., sep="\t") %>%
  setNames(c("CategoricalVariable","PaletteName")) %>%
  as_tibble()

mymre@metadata@metadata_df <-  tibble(metadata)


cat_df <- 
  here::here("Metadata", "CategoricalVariables.txt") %>% 
  read.delim(., header = T)

cat_vector <- cat_df %>% 
  pull(CategoricalVariable)

long_var <- here::here("Metadata", "LongitudinalVariables.txt") %>%
  read.delim(., header = T)  %>% 
  pull(LongitudinalVariable)

link_var <- here::here("Metadata", "LongitudinalVariables.txt") %>%
  read.delim(., header = T)  %>% 
  pull(LinkVariable)

num_var <- here::here("Metadata", "NumericalVariables.txt") %>%
  read.delim(., header = T)  %>% 
  pull(NumericalVariable)


```

```{r update_mre, echo = FALSE,warning= F, message= F, results=F}

#### This chunk is for updating the mre internally as new variables come out. Once the final mre is done this chunk will be removed.
devtools::load_all(here::here("..","WMGSPipeline"))


mymre <- filter_samples(mre = mymre, sample_ids = metadata$SampleID)

mymre@metadata@metadata_df <- as_tibble(metadata)

mymre@metadata@categorical_vals <- here::here("Metadata", "CategoricalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@numeric_vals <- here::here("Metadata", "NumericalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@longitudinal_vals <- here::here("Metadata", "LongitudinalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()


```

Let's tidy up the table into a long format, so it will be easier to plot from now on:

```{r extract_tables,message= F, warning=FALSE, echo = F}

pathways <- here::here("data","All_pathabun_relab.tsv") %>% 
  read.table(sep="\t", header = T, check.names = F,comment.char = "") %>% 
  setNames(.,str_remove_all(colnames(.), "_Abundance")) %>% 
  # dplyr::rename(pathway = `# Pathway`) %>% 
  tibble::column_to_rownames("# Pathway") %>% 
  dplyr::filter(!grepl("\\|", rownames(.)),
                !rownames(.) %in% c("UNMAPPED", "UNINTEGRATED"))


name_df <- 
  rownames(pathways) %>% 
  stringr::str_split_fixed(., ": ", n = 2) %>% 
  as.data.frame() %>% 
  stats::setNames(c("path", "description"))


path_df <- pathways %>% 
  t() %>% 
  as.data.frame() %>% 
  setNames(name_df$path) 


```

The first step will be to filter out those pathways that change significantly along the study in any group, an then we'll do pairwise comparisons. The filter idea is to reduce the computational load of the study, as performing pairwise comparisons for all pathways would be extremelly intensive. 

# First filter
We'll split the data between groups and then test for effect of time point by Kruskal Wallis in every pathway. We'll select those who have a p<0.05 in at least one group.

```{r first_filter, warning=F, message = F}

cat_var <- "group"

stat_list <- 
path_df %>%
  colnames() %>% 
  purrr::set_names() %>% 
  purrr::map(function(fn){
    # print(fn)
    test <- 
      path_df %>% 
      dplyr::select(path = fn) %>% 
      tibble::rownames_to_column("SampleID") %>% 
      dplyr::inner_join(metadata[,c("SampleID",cat_var, "time_point")], by="SampleID") %>% 
      dplyr::rename(cat_var = !!sym(cat_var)) %>% 
      dplyr::filter(time_point %in% c(0,48,96)) %>% 
      dplyr::group_by(cat_var) %>% 
      rstatix::kruskal_test(path ~ time_point) %>% 
      as.data.frame() %>% 
      dplyr::filter(p < 0.05)

  }) %>% 
  purrr::discard(.,  ~ nrow(.x) == 0)


print(paste("number of pathways that passed the filter: ",length(stat_list), sep=""))

```


We can see 69 pathways show significant differences over time in one or both groups. We'll go now for pairwise comparisons between groups, to have a better view of how they compare:


```{r pairwise_comps, message = F, warning=F, results = F, cache=F, echo = F}

cat_vector <- cat_df %>% 
  dplyr::filter(!CategoricalVariable %in% c("risk_group", "center", "ethnic_group")) %>% 
  pull(CategoricalVariable)

# if(file.exists(here::here("data","signif_paths.rds"))){
  res <- here::here("data","signif_paths.rds") %>% 
  readRDS(.)
# } 
# else{
#   res <-
#    cat_vector%>%
#   purrr::set_names() %>%
#   purrr::map(function(cv) {
#     
#   
#     
#   lev <- metadata %>% 
#       pull(!!sym(cv)) %>% 
#       unique()
#     
#   pal <- cat_df %>% 
#     dplyr::filter(CategoricalVariable == cv) %>% 
#     pull(PaletteName)
#     
#     stat_list %>%
#       # purrr::keep(names(.) == "ASPASN-PWY") %>%
#       # purrr::keep( ~ nrow(.x) > 0) %>%
#       names() %>%
#       purrr::set_names() %>%
#       purrr::map(function(fn)
#       {
#         print(fn)
#         df <- path_df %>%
#           dplyr::select(path = fn) %>%
#           rownames_to_column("SampleID") %>%
#           dplyr::inner_join(metadata[, c("SampleID", cv, "time_point", "record_id")], by =
#                               "SampleID") %>%
#           dplyr::rename(cat_var = !!sym(cv))
#         
#         if(any(
#         df %>%
#           filter(time_point %in% c(0, 48, 96)) %>% 
#           group_by(cat_var, time_point) %>% 
#           summarise(n = sum(path)) %>% 
#           pull(n) == 0)){
#           return(NULL)
#         } else {
#           
#         
# 
#         
#         test <-
#           df %>%
#           dplyr::filter(time_point %in% c(0, 48, 96)) %>%
#           dplyr::group_by(time_point) %>% 
#           rstatix::wilcox_test(path ~ cat_var, p.adjust.method = "none") %>%
#           rstatix::add_xy_position(., x = "time_point") %>%
#           # filter(p.adj < 0.05) %>%
#           dplyr::group_by(time_point) %>%
#           rstatix::adjust_pvalue("p", method = "BH") %>%
#           dplyr::ungroup() %>%
# 
# 
#           rstatix::add_significance("p.adj")
#         
#         
#         test_long <-
#           
#           df %>%
#           dplyr::filter(time_point %in% c(0, 48,96)) %>%
#           PairedWilcox_withNAs(myDF = ., IDs = "record_id", 
#                                Variable = "path", 
#                                Response = "time_point",
#                                Subsets = "cat_var") %>% 
#           dplyr::group_by(cat_var) %>% 
#           rstatix::adjust_pvalue(p.col = "p",method = "BH",output.col =  "p.adj") %>% 
#           dplyr::ungroup() %>% 
#           rstatix::add_x_position(., x="time_point",  group = "cat_var", dodge = 0.8) %>% 
#           rstatix::add_significance("p.adj") %>%
#           arrange(cat_var)
#         
#         print("boxplots")
#         
#         boxplot <-
#           df %>%
#           dplyr::filter(time_point %in% c(0, 48,96)) %>%
#           dplyr::mutate(time_point = as.factor(time_point)) %>%
#           ggplot(., aes(x = time_point, y = path)) +
#           geom_boxplot(aes(fill = cat_var), position = "dodge") +
#           ggpubr::stat_pvalue_manual(
#             data = test,
#             label = "p.adj.signif",
#             hide.ns = T,
#             y.position = quantile(df[, "path"], .95) *
#               1.1,
#             size = 6,
#             step.increase = 0.1,
#             bracket.size = 1
#           ) +
#           ggpubr::stat_pvalue_manual(
#             data = test_long,
#             label = "p.adj.signif",
#             hide.ns = T,
#             y.position = quantile(df[, "path"], .95) *
#               1.2,
#             step.increase = 0.1,
#             size = 6,
#             bracket.size = 1
#             
#           ) +
#           theme_bw() +
#           scale_fill_brewer(palette = pal) +
#           labs(title = fn)
#         
#         
#         boxplotstats <-
#           rbind(
#             test %>%
#               dplyr::rename(var = time_point) %>%
#               dplyr::select(var, group1, group2, n1, n2, p.adj),
#             test_long %>%
#               dplyr::rename(var = cat_var) %>%
#               dplyr::select(var, group1, group2, n1, n2, p.adj)
#           )
#         
#         print("lmms")
#         lmm <-
#           df %>% 
#           dplyr::filter(!is.na(cat_var)) %>% 
#           create_LMM(
#             data =  .,
#             num_var = "path",
#             cat_var = "cat_var",
#             long_var = "time_point",
#             link_var = "record_id",
#             breakpoints = NULL
#           )
#         
#         lmm_plot <-
#           lmm %>%
#           purrr::pluck("plot") +
#           scale_color_brewer(palette = pal) +
#           scale_fill_brewer(palette = pal)
#         # ggsave(filename = paste("Results/FunctionalAnnotation/DA/", fn,".svg", sep=""), dpi = 600, width = 20, height = 15, units = "cm")
#         
#         
#         lmm_stats <-
#           lmm %>%
#           pluck("stats")
#         
#         
#         print("multilmms")
#         multilmm <-
#           df %>% 
#           # dplyr::filter(!time_point == 9) %>%
#           get_lmm_effects(
#             .,
#             cat_vector = cv,
#             num_vector = "path",
#             long_var = "time_point",
#             link_var = "record_id",
#             title = T
#           )
#         
#         multilmm_plot <- multilmm %>% 
#           purrr::pluck(cv, "path","plot") +
#           labs(title = fn) +
#           scale_color_brewer(palette = pal) +
#           scale_fill_brewer(palette = pal)
#         
#         multilmm_stats <- multilmm %>% 
#           purrr::pluck(cv, "path", "summary")
#         
#         print("done")
#         return(list(
#           plots = list(
#             boxplot = boxplot,
#             lmm = lmm$plot,
#             multilmm = multilmm_plot
#           ),
#           stats = list(
#             boxplot = boxplotstats,
#             lmm = lmm_stats,
#             multilmm = multilmm_stats
#           )
#         ))}
#       })
#   })
# }


```


```{r further_filter, message = F, warning = F}

filtered_stats <- 
  res %>% 
  purrr::pluck("group") %>% 
  purrr::discard(., function(x) is.null(x)) %>% 
  names() %>% 
  purrr::set_names() %>% 
  map(~{
    # print(.x)
    if (.x %in% name_df$path){
      name <- name_df %>% 
        dplyr::filter(path == .x) %>% 
        pull(description)
      
    } else {name <- .x}
    
    res %>% 
      purrr::pluck("group",.x,"stats" ,"multilmm") %>% 
      tibble::rownames_to_column("variable") %>% 
      dplyr::filter(str_detect(variable,"long_var:cat_var*")) %>% 
      dplyr::filter(p < 0.05)
    
  }) %>% 
  purrr::keep(., function(x) nrow(x) > 0)

filtered_stats <- 
name_df %>% 
  dplyr::filter(path %in% names(filtered_stats)) %>% 
  pull(description) %>% 
  setNames(filtered_stats, .)

```

```{r venn_diagram, warning = F, message=FALSE}

library(ggVennDiagram)

comps_group <- list("DTG"=c("DTG_48","DTG_96"),
              "DRV/r" = c("DRV/r_48", "DRV/r_96"))

Venn_Group <- res$group %>%
  purrr::discard(is.null) %>% 
  names() %>% # Construct list for Venn diagram
  purrr::set_names() %>% 
  purrr::map_dfr(function(fn){
    res$group %>% 
      purrr::pluck(fn, "stats","boxplot") %>% 
      dplyr::filter(var %in% c(0,48,96),
                    p.adj < 0.05) %>% 
      mutate(path = fn) %>% 
      dplyr::select(var, path)
  }) %>%
  arrange(var) %>% 
  left_join(name_df, by = "path") %>% 
  filter(!path %in% path[var == 0]) # fiter those who already were significant at basal
  
sets <- list(
  `48` = Venn_Group %>% filter(var == 48) %>% pull(description),
  `96` = Venn_Group %>% filter(var == 96) %>% pull(description)
) 

sets %>%
  ggVennDiagram::ggVennDiagram(., show_intersect = T) 

res_df <- list(w48 = sets$`48`[!sets$`48` %in% sets$`96`],
                     w96 = sets$`96`[!sets$`96` %in% sets$`48`],
                     common = intersect(sets$`48`, sets$`96`))



res_df
```

