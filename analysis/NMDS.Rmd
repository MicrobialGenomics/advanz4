---
title: "Beta Diversity and NMDS"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r load_libraries,echo=FALSE, warning=F, message=FALSE}
library(metar)
library(phyloseq)
library(tidyverse)
library(vegan)
```

## Including Plots

You can also embed plots, for example:

```{r load_metadata_vars, eval=T, message = F}
myPath<-here::here()
setwd(myPath)
mymre<-readRDS("data/mre.rds")

metadata <- metar::get_metadata(mymre)@metadata_df

myphyloseq<-mymre@taxa@metaphlan@phyloseq
CategoricalVariablesDF <- get_metadata(mymre)@categorical_vals
NumericalVariablesDF <- get_metadata(mymre)@numeric_vals
LongitudinalVariablesDF <- get_metadata(mymre)@longitudinal_vals

```

```{r Get_DistMats, eval=T, include=F}

getAbundances<-function(phyloseq, level){
  
  collapsedPhyloseq<- phyloseq::tax_glom(phyloseq, level)
  
  OtuTable<- phyloseq::otu_table(collapsedPhyloseq) %>%
    magrittr::set_rownames(as.character(phyloseq::tax_table(collapsedPhyloseq)[,level])) %>%
    as.data.frame()
  return(OtuTable)
  
}




myAbundanceDF<- getAbundances(myphyloseq, "Species")

Top50<- myAbundanceDF %>%
    mutate(sum=rowSums(.)) %>%
    arrange(desc(sum)) %>%
    dplyr::slice(1:50) %>%
    rownames()



myNMDS <- myAbundanceDF %>%
    dplyr::filter(row.names(.) %in% Top50) %>%
    t() %>%
    as.data.frame() %>%
 
    metaMDS(.,distance="bray",trymax=100, 
            k = nrow(unique(metadata[,CategoricalVariablesDF$CategoricalVariable[1]]))) %>%
    pluck("points") %>%
    as.data.frame() %>%
  right_join(., metadata)

  # NMDS = data.frame(NMDS1 = dim_NMDS$points[,1], NMDS2 = dim_NMDS$points[,2])

BiPlotCoords<- envfit(myNMDS, myAbundanceDF, perm=999) 

BiPlotCoordsDF <- c("MDS1","MDS2","r","pvals") %>%
  set_names() %>%
  
  map_dfr(., ~ {
    
    if(.x %in% c("MDS1","MDS2")){
      BiPlotCoords$vectors$arrows[,.x] %>%
        as.numeric()
    } else{
      BiPlotCoords$vectors %>%
        pluck(.x) %>%
        as.numeric()
    } 
      
  }) %>%
  as.data.frame() %>%
  set_names(nm=c("NMDS1","NMDS2","r","p")) %>%
  dplyr::mutate(Dim1 = NMDS1*sqrt(r),
                Dim2 = NMDS2*sqrt(r),
                species = rownames(myAbundanceDF)) %>%
  dplyr::filter(species %in% Top50)
  



```

## NMDS by Treatment group


```{r NMDS}

long_var<-LongitudinalVariablesDF$LongitudinalVariable[1]
cat_var <- CategoricalVariablesDF$CategoricalVariable[1]
link_var <- LongitudinalVariablesDF$LinkVariable[1]
id_var <- "SampleID"

myPal<-RColorBrewer::brewer.pal(name =  CategoricalVariablesDF$PaletteName[1],
                                n=length(unique(metadata[,cat_var])))

myNMDS_DF <- myNMDS %>%
  rownames_to_column(var = id_var) %>%
  dplyr::full_join(., metadata, by =id_var) %>%
  dplyr::select(SampleID = id_var,
                NMDS1 = MDS1,
                NMDS2 = MDS2,
                linkVar = !!sym(link_var),
                catVar = !!sym(cat_var),
                LongVar = long_var)


  myXmin<-min(myNMDS$MDS1)
  # +(max(dim_NMDS$points[,1])-min(dim_NMDS$points[,1]))/20
  myYmin<-max(myNMDS$MDS2)-(max(myNMDS$MDS1)-min(myNMDS$MDS1))


myBrayDistMat <-vegdist(wisconsin(sqrt(t(myAbundanceDF))))
  
myAdonis<- adonis(myBrayDistMat~ catVar, data = myNMDS_DF) %>%
  pluck("aov.tab") %>%
  as.data.frame() %>%
  slice(1L) %>%
  magrittr::set_rownames(cat_var)
  
  
  library(ggrepel)
myNMDSBiplot<-ggplot(myNMDS_DF, aes(x=NMDS1, y=NMDS2)) + 
    geom_point(aes(colour=catVar, shape = as.character(LongVar)))+
    scale_colour_manual(values = myPal)+
    theme_bw()+
    theme(panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          
          axis.line=element_line(colour="black"),
          axis.text.x=element_text(size=11),
          axis.text.y=element_text(size=11),
          axis.title.x=element_text(size=11),
          axis.title.y=element_text(size=11),
          
          legend.text=element_text(size=11,face="italic"),
          legend.title=element_text(size=11))+
    
    ggtitle(expression(atop("Species composition",atop(italic("all samples"))))) +
    theme(plot.title=element_text(lineheight=1,face="bold",size=13))+
    stat_ellipse(geom="polygon",
                 alpha=0.15,color="black",
                 aes(fill=catVar),level=0.95)+
    scale_fill_manual(values=myPal)+
    # scale_size_manual(values = c(1:length(unique(myNMDS_DF[,"LongVar"])))/1.5) +
    geom_segment(data=BiPlotCoordsDF,aes(x=0,xend=Dim1,y=0,yend=Dim2),
                 arrow = arrow(length = unit(0.2,"cm")),colour="darkgrey")+
    geom_text_repel(data=BiPlotCoordsDF,aes(Dim1,Dim2,label=species),
                    size=2.5, box.padding = unit(0.25, "lines"),
                    segment.colour="black",
                    segment.alpha=0.5,
                    segment.size=0.10)+
    coord_fixed()+
    labs(fill = cat_var, color=cat_var)

```
