---
title: "BMI_stratification"
author: "Carlos Bl√°zquez Bondia"
date: "2023-03-06"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
source(here::here("code","LMM.R"))
source(here::here("code","myFunctions.R"))
source(here::here("code", "group_comparisons.R"))
library(ggalluvial)
library(RColorBrewer)
library(ggpubr)

```

```{r show_chunks, echo=F}
show = F
```

```{r load_data, message=F, warning=F, echo=FALSE}

mymre <- here::here("data", "filt_mre.rds") %>% 
  readRDS()


metadata <-
  here::here("Metadata") %>% 
    list.files(pattern = "clean_metadata", full.names = T) %>%
  file.info() %>% 
  dplyr::arrange(desc(ctime)) %>% 
  rownames() %>% 
  dplyr::first() %>% 
  read.csv()
  
mymre@metadata@categorical_vals <- here::here("Metadata", "CategoricalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@numeric_vals <- here::here("Metadata", "NumericalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@longitudinal_vals <- here::here("Metadata", "LongitudinalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

cat_vector <- get_cat(mymre) %>% 
  pull(CategoricalVariable)

num_vector <- 
  get_num(mymre) %>% 
  pull(NumericalVariable)


```

```{r support_funs, warning=F, message=F, echo = F}
peak_finder <-
  function(density, goal = "max",keep = F) {
    ### Let's define this function heere but we'll use it later
    stopifnot("goal can only be either local maxima (use: 'max') or local minima (use 'min)" = goal %in% c("min","max"))
    
    val <- case_when(goal == "max" ~ -2,
                   goal == "min" ~ 2)
    
    res <-
      density %>%
      purrr::keep(names(.) %in% c("x", "y")) %>%
      as.data.frame() %>%
      dplyr::mutate(is_peak = c(F, # 1st value can't be a local maxima, as there is no prior value to compare
                                diff(y) %>% # For each nth element of the vector, get (n+1) - n
                                  sign() %>%  # convert to -1 (n+1 is lower than n) or +1 (n+1 is higher than n)
                                  diff() == val, # if n is at a local maxima, both n+1 and n-1 are negative so [(n+1)-n] - [n - (n-1)] is -2
                                F)) # Last element can't be a local maxima either)
                    
                    if (!keep) {
                      res %>%
                        dplyr::filter(is_peak) %>%
                        dplyr::select(-is_peak)
                    } else{
                      res %>%
                        dplyr::select(-is_peak)
                    }
  }


```

```{r read_GR, echo = F, warning=F, message=F, results='hide'}
igc<-metar::get_diversity(mymre)@igc
Threshold <-  igc@dataTable %>%
  dplyr::select(SampleID, NumberMappedReads) %>%
  unique() %>%
  summarise(Q = quantile(NumberMappedReads,0.02)) %>% 
  as.numeric()


igc_df <- igc@dataTable %>%
                dplyr::filter(NumberMappedReads >= Threshold) %>%
                dplyr::filter(ReadCountReal>=Threshold) %>% ### Get the Mapped Read count (per-sample) just above the threshold
                dplyr::group_by(SampleID) %>%
                dplyr::summarise(across(everything(), min)) %>%
                dplyr::ungroup() %>%
          dplyr::right_join(., metadata, by="SampleID") %>%
          dplyr::select(SampleID,
                 richness = GeneNumber,
                 record_id = record_id,
                 group = group,
                 time_point = time_point,
                 NumberMappedReads, 
                 num_vector, 
                 height = height,
                 weight = weight) %>% 
  dplyr::mutate(sCD14 = as.numeric(sCD14),
         weight = case_when(record_id == "C007" & time_point == 48 ~ 69.7,
                            record_id == "D009" & time_point == 96 ~ 61.9,
                            record_id == "E008" & time_point == 0 ~ 39.1,
                            record_id == "D013" & time_point == 96 ~ 67,
                            TRUE ~ as.numeric(weight)),
         BMI = weight/((height/100)^2)) %>% 
  dplyr::mutate(group_bmi = factor(
    case_when(BMI < 18.5 ~ "underweight",
                                BMI >= 18.5 & BMI <=25 ~ "healthy_weight",
                                BMI > 25 ~ "overweight"),
    levels = c("underweight", "healthy_weight", "overweight")
    )) 


delta_bmi_df <-
    igc_df %>%
      dplyr::filter(!is.na(richness), !is.na(BMI),
                    !SampleID == "ADZ4_27") %>%
      group_by(record_id) %>%
  dplyr::filter(any(time_point == 0),
                any(time_point == 96)) %>%
      mutate(bmi0 = BMI[time_point == 0],
             gr0 = richness[time_point == 0], 
    delta_BMI_abs = BMI - BMI[time_point == 0],
         delta_BMI_rel = (BMI - BMI[time_point == 0])*100 / BMI[time_point == 0],
         delta_gr_abs = richness - richness[time_point == 0],
         delta_gr_rel = (richness - richness[time_point == 0]) / (richness + richness[time_point == 0]))


```

Stratification by BMI
=====================

This set of tests comes from recent studies which found that INSTIs are associated with greater BMI increases, respective to other treatments in ART-receiving patients. BMI is highly related to gut health, metabolism and microbiome, and may be a possible confussor regarding the interaction between treatment and microbiote, especially gene richness, as it may be masking the actual effect of treatment. The first is to assess how big of an impact our treatments have on the patients BMIs.

As we are looking strictly at BMI now, we'll use the entries for ALL participants included in the study, regardless of wether there are faecal samples in a certain timepoint or not.

```{r read_complete_BMI, warning = F, message = F, echo = show}


all_bmis<- here::here("Metadata","MetadataManagement","Vital.xlsx") %>%
  readxl::read_excel() %>%
  filter(PatCode != "TMP??-000") %>%
  pivot_wider(id_cols = c("PatCode", "Week"),names_from="ParamName", values_from = "Result") %>%
  dplyr::rename(record_id = PatCode,
         time_point = Week,
         weight = Weight,
         height = Height) %>%
  mutate(time_point = as.numeric(time_point),
         record_id = gsub("-","",record_id),
         weight = case_when(record_id == "C007" & time_point == 48 ~ 69.7,
                            record_id == "D009" & time_point == 96 ~ 61.9,
                            record_id == "E008" & time_point == 0 ~ 39.1,
                            record_id == "D013" & time_point == 96 ~ 67,
                            record_id == "E004" & time_point == 24 ~ 68.1,
                            TRUE ~ as.numeric(weight)))  %>%
  relocate(record_id, time_point,weight, height, BMI) %>% 
  dplyr::filter(record_id %in% metadata$record_id,
                time_point %in% c(0,24,48,96)) %>% 
  dplyr::mutate(across(everything(), ~ str_replace_all(.x, "^[[.]]$|^$", NA_character_)),
                weight = as.numeric(weight),
                height = as.numeric(height)) %>%  
  dplyr::mutate(BMI = weight/((height/100)^2)) %>% 
  complete(., record_id,time_point) %>% 
  left_join(unique(metadata[,c("record_id","group")]), by = "record_id") %>% 
  mutate(SampleID = as.factor(seq(1:nrow(.))),
         group_bmi = factor(
                      case_when(BMI < 18.5 ~ "underweight",
                                                  BMI >= 18.5 & BMI <=25 ~ "healthy weight",
                                                  BMI > 25 ~ "overweight"),
                      levels = c("underweight", "healthy weight", "overweight")
                      )) 

# all_bmis %>%
#  ggplot(aes(x = record_id, y = BMI)) +
#   geom_point() +
#   geom_text(aes(label = record_id))


```

```{r BMI_vs_group, warning=FALSE, message=FALSE, echo = show}

all_bmis %>% 
  dplyr::select(SampleID,record_id, group, time_point, BMI) %>% 
  dplyr::mutate(time_point = as.numeric(time_point)) %>% 
  get_lmm_effects(.,cat_vector = "group", num_vector = "BMI", long_var = "time_point", link_var = "record_id", title = "BMI evolution/group") %>%
  purrr::pluck("group","BMI","plot") +
  scale_color_manual(values = c("black","grey")) +
  scale_linetype_manual(labels = c("DTG", "DRV"),values = c(1,2))


require(rstatix)
bmi_test <-
get_comp_boxplots(dat = all_bmis, cat_var = "group", num_var = "BMI", long_var = "time_point", link_var = "record_id", pal = "Accent", include.pvals = "none")


bmi_test$plot +
  labs(color = "group") +
  scale_fill_manual(values = c("black","grey"))

bmi_test$test$cat %>%
  dplyr::select(long_var, contains ( "group"),p ,p.adj.signif) %>%
  kableExtra::kable(format = "markdown")

bmi_test$test$long %>%
  dplyr::select(cat_var, contains ( "group"),p ,p.adj.signif) %>%
  kableExtra::kable(format = "markdown")


```

Turns out looking at BMI alone, no categorical differences can be found. While both treatment groups significantly increase in BMI, no diferences between DTG an DRV are found.

Anyhow, this may have something to do with BMI differences at BL. Let's check for its distribution:

```{r basal_dist_df, warning=F, message=FALSE, echo = show}
peaks_bl <- all_bmis %>%
  dplyr::filter(time_point == 0, !is.na(BMI)) %>%
  dplyr::pull(BMI) %>%
  density() %>%
  peak_finder(goal = "max")

median_bl <- all_bmis %>%
  dplyr::filter(time_point == 0, !is.na(BMI)) %>%
  dplyr::pull(BMI) %>%
  median()

all_bmis %>%
  dplyr::filter(time_point == 0, !is.na(BMI)) %>%
  ggplot(.) +
  # geom_histogram(aes(x = BMI), fill = "grey", bins = 100) +
  geom_density(aes(x = BMI, color = group),bins = 100) +
  theme_bw() +
  geom_vline(xintercept = peaks_bl$x, lty = 3) +
  geom_vline(xintercept = median_bl, col = "red") +
  geom_text(data = peaks_bl, aes(x = x, y = y*.9, label = round(x, 3))) +
  geom_text(aes(x = median_bl, y = max(peaks_bl$y)*.5, label = round(median_bl,3))) +
  labs(x = "BMI", y = "kernel density", title = "BMI distribution at baseline") +
  theme(axis.title.y = element_blank()) +
  scale_color_manual(values = c("black","grey"))




```

It seems there is a certain bimodality in the distribution of BMI at BL in the DTG, in which a peak of patients emerges around BMI of 28. Anyway, both groups have their peaks farily close to the overall median, and their distributions, especially in the bDRV group approaches normality. The overall median is 22.064, which is well within the healthy weight.

-   18.5 (Underweight)
-   18.5 to 25 (healthy weight).
-   25 (overweight)

The total number of patients in each group at basal is as follows

```{r print_bmi_table, echo = F, message=FALSE, warning=FALSE}

all_bmis %>%
  dplyr::filter(time_point == 0, !is.na(BMI))%>%
  # nest_by(cat_var) %>%
  compareGroups::compareGroups(formula = group ~ group_bmi) %>%
  compareGroups::createTable(.) %>%
  compareGroups::export2md()

```

As we can see, the majority of the cohort is within the range of healthy weight and both groups are pretty well balanced at baseline. This sets a good statistical base from which to find signals after treatment.

Longitudinal evolution of BMI
=============================

Before entering in the complexities of gut microbiota, we'll assess wether DTG/bDRV have a differential effect on the chances of patients changing BMI categories. A good way to visualize this will be an alluvial plot.

```{r alluvial_plot, warning = F, message = F, echo = show, fig.width= 12, fig.height = 9}
alluvialplot <- 
all_bmis %>%
  dplyr::mutate(group_bmi = ifelse(is.na(group_bmi), "no data", as.character(group_bmi))) %>%
  dplyr::mutate(group_bmi = factor(group_bmi, levels = c("underweight", "healthy weight", "overweight","no data"))) %>%
  # dplyr::filter(!is.na(group_bmi)) %>%
  # arrange(cat_var) %>%
  ggplot(aes(x = as.factor(time_point), stratum = group_bmi, label = group_bmi, fill = group_bmi,alluvium = record_id, )) +
  facet_wrap(facets = ~ group) +
  geom_flow(stat = "alluvium",  na.rm = F, width = 0, color = "black", alpha = .8,) +
    geom_stratum(color="black", alpha = 1) +

  geom_text(stat = "alluvium", aes(label = record_id, color = group_bmi), size = 2.4) +
  scale_color_manual(values= c("black","white","white", "#222222")) +
  theme_bw() +
  scale_fill_manual(values = c("#DDDDDD","#777777","#000000", "#FFFFFF")) +
  labs(x = "weeks", fill = "BMI category") +
  theme(strip.background = element_rect(color = "black"),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 12, face = "bold"),
        axis.line.x = element_line(colour = "black"),
        axis.title.x = element_text(size = 14, face = "bold"),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, face = "bold"),
        strip.text = element_text(size = 14, face = "bold"),
        strip.background.x = element_rect(fill = "white")
          ) +
  guides(color = "none")

ggsave(alluvialplot, filename = here::here("output","figures" ,"bmi_alluvial.svg"), device = "svg", height = 18, width = 24, units = "cm")


```

There is an increase in overweight incidence in both groups, but it is more noticeable in the DTG group. In the bDRV it appears the BMI increase is more temporary, as many patients who become overweight after treatment initiation, return to a healthy weight after 96 weeks. This is not the case in the DTG group, however, where all the participants who become overweight remain so during the whole study.

The population of underweight seems to improve more in the DTG, as none of the participants fall into this category as soon as week 48, while sme patients remain so along the whole study in the bDRV arm.

GR Stratification by BMI at baseline
====================================

Now it is time to assess whether the BMI category may be affecting/be influenced by gene richness. The First thing we should look is whether baseline richness is influencing the bmi of our cohort

### GR vs BMI correlation at baseline

Now we found a threshold appropiate to split by BMI, we can stratify the population by treatment and bmi, vs gene richness.

```{r BMI_vs_GR_BL, warning = F, message = F, echo = show}

test_cors_OA <- 
      igc_df %>%
        dplyr::filter(time_point == 0,
                    !SampleID == "ADZ4_27") %>%
        dplyr::filter(!is.na(BMI), !is.na(richness)) %>%
        rstatix::cor_test(BMI, richness)  %>% 
  dplyr::mutate(group = "overall",.before = 1)
      
test_cors_group <- 
igc_df %>%
        dplyr::filter(time_point == 0,
                    !SampleID == "ADZ4_27") %>%
        dplyr::filter(!is.na(BMI), !is.na(richness)) %>%
        dplyr::group_by(group) %>% 
      rstatix::cor_test(BMI, richness)


corr_BL <-
  delta_bmi_df %>%
  dplyr::filter(time_point == 0,
                    !SampleID == "ADZ4_27") %>%
  ggplot(aes(x = richness, y = BMI)) +
  geom_point() +
  geom_smooth(method = "glm", color = "black") +
  geom_smooth(method = "glm", aes(lty = group))+
  labs(title = "BMI vs GR",subtitle = "baseline", x = "Gene richness at baseline", y = "BMI at baseline") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#AAAAAA", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_fill_manual(values = c("#AAAAAA","#AAAAAA","#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_linetype_manual(values = c(2,3,1), limits = c("bDRV", "DTG", "overall")) +
  annotation_custom(grob = gridExtra::tableGrob(test_cors_group %>% 
                                                  rbind(test_cors_OA) %>% 
                                                  dplyr::select(group, cor, p), theme = gridExtra::ttheme_minimal()), xmax =  700000, ymin = 25)
corr_BL

```

No correlation could be found between BMI and GR at baseline in either group nor overall. However, the microbiota may still influence later BMI changes, or even just BMI at later times. Now we'll correlate GRBL to BMI at different timepoints:

```{r BMI_timepoints, warning = F, message = F, echo = show}


test_cors_OA <-
  igc_df %>%
  dplyr::group_by(time_point) %>%
  dplyr::filter(!is.na(BMI), !is.na(richness),
                    !SampleID == "ADZ4_27") %>%
  rstatix::cor_test(BMI, richness)  %>%
  dplyr::mutate(group = "overall", )

test_cors_group <- 
igc_df %>%
        dplyr::filter(!is.na(BMI), !is.na(richness),
                    !SampleID == "ADZ4_27") %>%
        dplyr::group_by(group, time_point) %>% 
      rstatix::cor_test(BMI, richness)

test_cors_group %>%
  rbind(test_cors_OA) %>%
  dplyr::select(group, time_point,cor, p)
test_cors <- test_cors_group %>%
  rbind(test_cors_OA) %>%
  dplyr::select(group, time_point, cor, p) %>% 
  dplyr::mutate(x = 400000, 
                y = case_when(
                  group == "bDRV" ~ 36,
                  group == "DTG" ~ 34,
                  group == "overall" ~ 32
                ))

corr_BL <-
  delta_bmi_df %>%
  dplyr::filter(!SampleID == "ADZ4_27") %>%
  # unique() %>%
  ggplot(aes(x = gr0, y = BMI)) +
  facet_wrap(~ time_point ) +
  geom_point() +
  geom_smooth(method = "glm", color = "black", fill = NA) +
  geom_smooth(method = "glm", aes(lty = group, color = group), fill = NA)+
  geom_text(data = test_cors, aes(label = paste(group,"cor = ",cor, "p =", p), x = x, y = y, color = group), vjust=1, hjust = 0.1)+
  # geom_label(data = test_cors_group, aes(label = paste("spearman rho =",cor, "p =", p), x = min(delta_bmi_df$gr0), y = Inf, color = group), vjust=2, hjust = 0.1)+
  labs(title = "BMI vs GR",subtitle = "per time", x = "Gene richness at baseline", y = "BMI") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#AAAAAA", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_fill_manual(values = c("#AAAAAA","#AAAAAA","#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_linetype_manual(values = c(2,3,1), limits = c("bDRV", "DTG", "overall")) 
corr_BL



```

Also, we can see there is a patient with a REALLY low gene count, although it passed the 2nd percentile filtering. Patient E006 at month 0 received trteatment for a latent syphlis infection, just a week before collecting the sample. This means he received a penicilin injection hammered its microbiota to oblivion, and may be wise to discard it.

But, does baseline richness influence the the distribution of BMI groups at a specific timepoint? This could shed some light as why we didn't find any correlation, as the effect of baseline richness may only manifest very late or very early and dilute afterwards. the best way to look at this is via boxlots:

```{r gr0_BMI_cat_boxplots, warning = F, message = F, echo = show}

gr0_bmi_cattest <- 
  delta_bmi_df %>% 
  dplyr::group_by(time_point, group_bmi) %>% 
  dplyr::filter(group_bmi != "underweight") %>% 
  rstatix::wilcox_test(gr0 ~ group) %>% 
  rstatix::add_xy_position(x = "group_bmi", group = "group")


gr0_bmi_OAtest <- 
  delta_bmi_df %>% 
  dplyr::group_by(time_point) %>% 
  rstatix::wilcox_test(gr0 ~ group_bmi) %>% 
  rstatix::add_xy_position(x = "group_bmi", group = "group")

gr0_bmi_bp <- 
delta_bmi_df %>%
  dplyr::select(record_id, group_bmi, group, time_point, gr0) %>% 
  dplyr::mutate(group = "overall") %>% 
  rbind(.,delta_bmi_df[,c("record_id", "group_bmi", "group", "time_point", "gr0")]) %>% arrange(record_id, time_point) %>% 
  # mutate(OA = "overall") %>% 
  # unique() %>%
  ggplot(aes(x = group_bmi, y = gr0)) +
  facet_wrap(~ time_point ) +
  geom_boxplot(aes(fill = group)) +
  # geom_boxplot(inherit.aes = F, aes(x = OA, y = gr0))
  # stat_compare_means(method = "wilcox.test", label = "..p.signif..", hide.ns = F)+
  labs(title = "BMI vs GR",subtitle = "per time", x = "BMI category", y = "Gene richness at baseline") +
  stat_pvalue_manual(data = gr0_bmi_cattest, hide.ns = T) +
  stat_pvalue_manual(data = gr0_bmi_OAtest, hide.ns = T) +

  theme_light() +
  scale_color_manual(values = c("#FFFFFF", "#999999", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_fill_manual(values = c("#FFFFFF", "#999999", "#000000"), limits = c("bDRV", "DTG", "overall")) 

ggsave(gr0_bmi_bp, filename = here::here("output", "figures", "GR0_BMI_Boxplots.svg"), device = "svg", 
       width = 20, height = 15, units = "cm")


```

No differences between treatment group or bmi group could be observed in what regards to their respective GR at baseline in any timepoint. This suggests gene richness may not have an overall big impact on the BMI, regardless of group.

Stratification by BMI changes
=============================

Maybe the increase in gene richness may be associated not so much to absolute BMI but of changes in BMI. In this part we'll correlate richness to changes in BMI over time.

Baseline richness vs BMI changes
--------------------------------

The first hypotesis to test is whether differences in richness may be affecting BMI changes after treatment.

```{r delta_cors_BL, warning=FALSE, message=F, echo = show, fig.height= 8, fig.width=9}




test_gr0_abs_group <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point, group) %>%
  rstatix::cor_test(gr0, delta_BMI_abs, method = "spearman", use = "complete.obs")

test_gr0_abs <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point) %>%
  rstatix::cor_test(gr0, delta_BMI_abs, method = "spearman", use = "complete.obs") %>% 
  dplyr::mutate(group = "overall", .before = 1) %>% 
  rbind(test_gr0_abs_group) %>% 
  mutate(x = 250000, 
         y = case_when(
           group == "bDRV" ~ 10,
           group == "DTG" ~ 9,
           group == "overall" ~ 8
         ))



deltas_gr0_abs <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  # unique() %>%
  ggplot(aes(x = richness, y = delta_BMI_abs)) +
  facet_wrap(~ time_point, ) +
  geom_point() +
  geom_smooth(method = "glm", aes(colour = group, lty = group), fill = NA) +
  geom_smooth(method = "glm", colour = "black", fill = NA) +
  geom_text(data = test_gr0_abs, 
             aes(label = paste(group, "cor = ",cor, "p =", p), x = x, y = y, colour = group), 
             inherit.aes = F, vjust=1, hjust = 0.1, size = 3)+
  labs(title = "Absolute", x = "Gene richness at baseline", y = "BMI increase from baseline") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#AAAAAA", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_fill_manual(values = c("#AAAAAA","#AAAAAA","#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_linetype_manual(values = c(2,3,1), limits = c("bDRV", "DTG", "overall")) 


test_gr0_rel_group <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point, group) %>%
  rstatix::cor_test(gr0, delta_BMI_rel, method = "spearman", use = "complete.obs")

test_gr0_rel <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point) %>%
  rstatix::cor_test(gr0, delta_BMI_rel, method = "spearman", use = "complete.obs") %>% 
  dplyr::mutate(group = "overall", .before = 1) %>% 
  rbind(test_gr0_rel_group) %>% 
  mutate(x = 400000, 
         y = case_when(
           group == "bDRV" ~ 50,
           group == "DTG" ~ 47,
           group == "overall" ~ 44
         ))


deltas_gr0_rel <- 
  delta_bmi_df %>% 
  dplyr::filter(!time_point == 0) %>% 
  ggplot(aes(x = gr0, y = delta_BMI_rel, color = group)) +
  facet_wrap(~ time_point, ) +
  geom_point() +
  geom_smooth(method = "glm", aes(colour = group, lty = group), fill = NA) +
  geom_smooth(method = "glm", colour = "black", fill = NA) +
  geom_text(data = test_gr0_rel, 
             aes(label = paste(group, "cor = ",cor, "p =", p), x = x, y = y, colour = group), 
             inherit.aes = F, vjust=1, hjust = 0.1, size = 3)+
  labs(title = "Relative", x = "Gene richness at baseline", y = "BMI increase from baseline") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#AAAAAA", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_fill_manual(values = c("#AAAAAA","#AAAAAA","#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_linetype_manual(values = c(2,3,1), limits = c("bDRV", "DTG", "overall")) 



ggpubr::ggarrange(deltas_gr0_abs, deltas_gr0_rel, common.legend = T, ncol = 1, nrow = 2)

```

Again, nothing. No correlation between richness at basal and change of BMI at any timepoint could be found.

BMI vs GR change
----------------

We already look on the effect of gene richness at baseline, but now the next question would be whether the chages in richness we reported before are linked to BMI changes as well.

```{r plot_distributions_96, eval = T, warning = F, message = F, echo = show}



peaks_abs <-
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(group == treat) %>% 
      dplyr::pull(delta_BMI_abs) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(group = treat)
  })


plot_delta_abs <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_abs)) +
  geom_density(aes(color = group)) +
  geom_vline(aes(color = group), xintercept = peaks_abs$x, lty = 3) +
  geom_text(data = peaks_abs, aes(x = peaks_abs$x, y = peaks_abs$y*.9,label = peaks_abs$x, color = group)) +
  theme_light() +
  labs(title = "Absolute", x = "BMI increase")  +
  scale_color_manual(values = c("#AAAAAA", "#000000"))




peaks_rel <- 
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(group == treat) %>% 
      dplyr::pull(delta_BMI_rel) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(group = treat)
  })

plot_delta_rel <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_rel,color = group)) +
  geom_density(aes(color = group)) +
  geom_vline(data = peaks_rel, aes(color = group), xintercept = peaks_rel$x, lty = 3) +
  geom_text(data = peaks_rel, aes(x = x, y = y*.9,label = x, color = group)) +
  labs(title = "Relative (%)", x = "BMI increase") +
  theme_light()+
  theme(axis.title.y = element_blank()) +
  scale_color_manual(values = c("#AAAAAA", "#000000"))



# delta_bmi_df %>% 



ggpubr::ggarrange(plot_delta_abs, plot_delta_rel, common.legend = T) %>% 
  ggpubr::annotate_figure(top = text_grob("Distribution of BMI increases, week 96"))


```

Both treatment groups appear to have a unimodal distribution regarding their BMI increase at week 96, both in absolute and relative terms. However there seems to be a shift between both, as the "valley" between both peaks in the DTG group seems to be shifted toward the left, relative to the DRV group.

```{r lmms_deltas, message = F, warning = F,echo = show ,fig.height=8, fig.width=6}
test_abs_group <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point, group) %>%
  rstatix::cor_test(delta_gr_abs, delta_BMI_abs, method = "spearman", use = "complete.obs")

test_abs <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point) %>%
  rstatix::cor_test(delta_gr_abs, delta_BMI_abs, method = "spearman", use = "complete.obs") %>% 
  dplyr::mutate(group = "overall", .before = 1) %>% 
  rbind(test_abs_group) %>% 
  mutate(x = -650000, 
         y = case_when(
           group == "bDRV" ~ 10,
           group == "DTG" ~ 9,
           group == "overall" ~ 8
         ))



deltas_abs <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  # unique() %>%
  ggplot(aes(x = delta_gr_abs, y = delta_BMI_abs)) +
  facet_wrap(~ time_point, ) +
  geom_point() +
  geom_smooth(method = "glm", aes(colour = group, lty = group), fill = NA) +
  geom_smooth(method = "glm", colour = "black", fill = NA) +
  geom_text(data = test_abs, 
             aes(label = paste(group, "cor = ",cor, "p =", p), x = x, y = y, colour = group), 
             inherit.aes = F, vjust=1, hjust = 0.1, size = 3)+
  labs(title = "Absolute", x = "Gene richness at baseline", y = "BMI increase from baseline") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#AAAAAA", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_fill_manual(values = c("#AAAAAA","#AAAAAA","#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_linetype_manual(values = c(2,3,1), limits = c("bDRV", "DTG", "overall")) 


test_rel_group <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point, group) %>%
  rstatix::cor_test(delta_gr_rel, delta_BMI_rel, method = "spearman", use = "complete.obs")

test_rel <-
  delta_bmi_df %>%
  dplyr::filter(!time_point == 0) %>%
  group_by(time_point) %>%
  rstatix::cor_test(delta_gr_rel, delta_BMI_rel, method = "spearman", use = "complete.obs") %>% 
  dplyr::mutate(group = "overall", .before = 1) %>% 
  rbind(test_rel_group) %>% 
  mutate(x = -0.8, 
         y = case_when(
           group == "bDRV" ~ 40,
           group == "DTG" ~ 37,
           group == "overall" ~ 34
         ))


deltas_rel <- 
  delta_bmi_df %>% 
  dplyr::filter(!time_point == 0) %>% 
  ggplot(aes(x = delta_gr_rel, y = delta_BMI_rel, color = group)) +
  facet_wrap(~ time_point, ) +
  geom_point() +
  geom_smooth(method = "glm", aes(colour = group, lty = group), fill = NA) +
  geom_smooth(method = "glm", colour = "black", fill = NA) +
  geom_text(data = test_rel, 
             aes(label = paste(group, "cor = ",cor, "p =", p), x = x, y = y, colour = group), 
             inherit.aes = F, vjust=1, hjust = 0.1, size = 3)+
  labs(title = "Relative", x = "Gene richness at baseline", y = "BMI increase from baseline") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#AAAAAA", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_fill_manual(values = c("#AAAAAA","#AAAAAA","#000000"), limits = c("bDRV", "DTG", "overall")) +
  scale_linetype_manual(values = c(2,3,1), limits = c("bDRV", "DTG", "overall")) 



ggpubr::ggarrange(deltas_abs, deltas_rel, common.legend = T, ncol = 1, nrow = 2)

```

No significant differences in trends could be observed either. Interesting to note, in the absolute plot there are 2 apparent outliers. Those took antibiotics at some point of the study and it reflected in a significant loss of gene richness, but in absolute numbers they aren't really low on richness, it's just the change.

Now let's categorize these results:

```{r BMI_class_boxplots, warning = F, message = F,echo = show, fig.width=5, fig.height=6}

deltas_abs <- 
  delta_bmi_df %>% 
  dplyr::filter(!time_point == 0) %>% 
  ggplot(aes(x = group_bmi, y = delta_gr_abs, color = group)) +
  facet_wrap(~ time_point ) +
  geom_boxplot() +
  labs(title = "Absolute", x = "Gene richness at baseline", y = "GR increase from baseline") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#555555", "#000000")) +
  scale_fill_manual(values = c("#AAAAAA", "#555555", "#000000")) +
  stat_compare_means(method = "kruskal.test", label = "p.signif", hide.ns = T) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))



deltas_rel <- 
  delta_bmi_df %>% 
  dplyr::filter(!time_point == 0) %>% 
  ggplot(aes(x = group_bmi, y = delta_gr_rel, color = group)) +
  facet_wrap(~ time_point ) +
  geom_boxplot() +
  labs(title = "Relative", x = "Gene richness at baseline", y = "GR increase from baseline") +
  theme_light() +
  scale_color_manual(values = c("#AAAAAA", "#555555", "#000000")) +
  scale_fill_manual(values = c("#AAAAAA", "#555555", "#000000")) +
  stat_compare_means(method = "kruskal.test", label = "p.signif", hide.ns = T) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))




ggpubr::ggarrange(deltas_abs, deltas_rel, common.legend = T, ncol = 1, nrow = 2)

```

A we can see, no differences between groups in GR increase could be fond for any of the BMI groups. While it seems there is some in the Overweight group at week 24, it is not significant due to the low n present in the group (n = 1 in the case of bDRV Overweight). Remember the actual Ns won't necessarily match the alluvial plot's as the GR analysis are constricted only to those with present faecal samples.
