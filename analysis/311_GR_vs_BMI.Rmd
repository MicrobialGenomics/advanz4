---
title: "BL_stratification"
author: "Carlos Bl√°zquez Bondia"
date: "2023-03-06"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
source(here::here("code","LMM.R"))
source(here::here("code","myFunctions.R"))
source(here::here("code", "group_comparisons.R"))
library(RColorBrewer)

```

```{r load_data, message=F, warning=F, echo=FALSE}

mymre <- here::here("data", "filt_mre.rds") %>% 
  readRDS()


metadata <-
  here::here("Metadata") %>% 
    list.files(pattern = "clean_metadata", full.names = T) %>%
  file.info() %>% 
  dplyr::arrange(desc(ctime)) %>% 
  rownames() %>% 
  dplyr::first() %>% 
  read.csv()
  
mymre@metadata@categorical_vals <- here::here("Metadata", "CategoricalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@numeric_vals <- here::here("Metadata", "NumericalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@longitudinal_vals <- here::here("Metadata", "LongitudinalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

cat_vector <- get_cat(mymre) %>% 
  pull(CategoricalVariable)

num_vector <- 
  get_num(mymre) %>% 
  pull(NumericalVariable)


```

```{r support_funs, warning=F, message=F, echo = F}
peak_finder <-
  function(density, goal = "max",keep = F) {
    ### Let's define this function heere but we'll use it later
    stopifnot("goal can only be either local maxima (use: 'max') or local minima (use 'min)" = goal %in% c("min","max"))
    
    val <- case_when(goal == "max" ~ -2,
                   goal == "min" ~ 2)
    
    res <-
      density %>%
      purrr::keep(names(.) %in% c("x", "y")) %>%
      as.data.frame() %>%
      dplyr::mutate(is_peak = c(F, # 1st value can't be a local maxima, as there is no prior value to compare
                                diff(y) %>% # For each nth element of the vector, get (n+1) - n
                                  sign() %>%  # convert to -1 (n+1 is lower than n) or +1 (n+1 is higher than n)
                                  diff() == val, # if n is at a local maxima, both n+1 and n-1 are negative so [(n+1)-n] - [n - (n-1)] is -2
                                F)) # Last element can't be a local maxima either)
                    
                    if (!keep) {
                      res %>%
                        dplyr::filter(is_peak) %>%
                        dplyr::select(-is_peak)
                    } else{
                      res %>%
                        dplyr::select(-is_peak)
                    }
  }


```


```{r read_GR, echo = F, warning=F, message=F, results='hide'}
igc<-metar::get_diversity(mymre)@igc
Threshold <-  igc@dataTable %>%
  dplyr::select(SampleID, NumberMappedReads) %>%
  unique() %>%
  summarise(Q = quantile(NumberMappedReads,0.02)) %>% 
  as.numeric()


igc_df <- igc@dataTable %>%
                filter(NumberMappedReads >= Threshold) %>%
                filter(ReadCountReal>=Threshold) %>% ### Get the Mapped Read count (per-sample) just above the threshold
                group_by(SampleID) %>%
                summarise(across(everything(), min)) %>%
                ungroup() %>%
          right_join(., metadata, by="SampleID") %>%
          select(SampleID,
                 richness = GeneNumber,
                 link_var= record_id,
                 cat_var = group,
                 long_var = time_point,
                 NumberMappedReads, 
                 num_vector, 
                 height = Height,
                 weight = Weight) %>% 
  mutate(sCD14 = as.numeric(sCD14),
         weight = case_when(link_var == "C007" & long_var == 48 ~ 69.7,
                            link_var == "D009" & long_var == 96 ~ 61.9,
                            link_var == "E008" & long_var == 0 ~ 39.1,
                            link_var == "D013" & long_var == 96 ~ 67,
                            TRUE ~ as.numeric(weight)),
         BMI = weight/((height/100)^2))


```



# Stratification by BMI

This set of tests comes from recent studies which found that INSTIs are associated with greater BMI increases, respective to other treatments in ART-receiving patients. BMI is highly related to gut health, metabolism and microbiome, and may be a possible confussor regarding the interaction between treatment and microbiote, especially gene richness, as it may be masking the actual effect of treatment. The first is to assess how big of an impact our treatments have on the patients BMIs:


```{r BMI-vs_group, warning=FALSE, message=FALSE}

igc_df %>% 
  dplyr::select(SampleID, link_var, cat_var, long_var, BMI) %>% 
  get_lmm_effects(.,cat_vector = "cat_var", num_vector = "BMI", long_var = "long_var", link_var = "link_var", title = "BMI evolution/group")
  

require(rstatix)
bmi_test <- 
get_comp_boxplots(dat = igc_df, cat_var = "cat_var", num_var = "BMI", long_var = "long_var", link_var = "link_var", pal = "Accent")


bmi_test$plot

bmi_test$test$cat %>% 
  dplyr::select(long_var, contains ( "group"), p.adj.signif) %>% 
  kableExtra::kable(format = "markdown")


```

Turns out looking at BMI alone, no categorical differences can be found. While both treatment groups significantly increase in BMI, no diferences between DTG an DRV are found.

Anyhow, this may have something to do with BMI differences at BL. Let's check for its distribution:


```{r basal_dist_df}
peaks_bl <- igc_df %>% 
  dplyr::filter(long_var == 0, !is.na(BMI)) %>% 
  dplyr::pull(BMI) %>%
  density() %>% 
  peak_finder(goal = "max")

median_bl <- igc_df %>% 
  dplyr::filter(long_var == 0, !is.na(BMI)) %>% 
  pull(BMI) %>% 
  median()

igc_df %>% 
  dplyr::filter(long_var == 0, !is.na(BMI)) %>% 
  ggplot(.) +
  # geom_histogram(aes(x = BMI), fill = "grey", bins = 100) +
  geom_density(aes(x = BMI, color = cat_var),bins = 100) +
  theme_bw() +
  geom_vline(xintercept = peaks_bl$x, lty = 3) +
  geom_vline(xintercept = median_bl, col = "red") +
  geom_text(data = peaks_bl, aes(x = x, y = y*.9, label = round(x, 3))) +
  geom_text(aes(x = median_bl, y = max(peaks_bl$y)*.5, label = round(median_bl,3))) +
  labs(x = "BMI", y = "kernel density", title = "BMI distribution at baseline") +
  theme(axis.title.y = element_blank())



igc_df %>% 
  dplyr::filter(long_var == 0, !is.na(BMI)) %>% 
  dplyr::mutate(BMI_c = case_when(BMI >= 22 ~ "high",
                                  BMI < 22 ~ "low")) %>% 
  group_by(BMI_c) %>% 
  tally() %>% 
  kableExtra::kable(format="markdown")









```

It seems there is a certain bimodality in the distribution of BMI at BL in the DTG. However, still seems to be close to normal, so the max peak of 21.57 is fairly close to the median of 22.084. From this it 22 seems a good cut-off point between high and low BMI.



```{r kmeans_split, warning=FALSE, message=FALSE}


bmi_c <- 
igc_df %>% 
  dplyr::filter(long_var == 0, !is.na(BMI)) %>% 
  dplyr::select(link_var, long_var, cat_var, BMI, richness) %>% 
  mutate(cluster = kmeans(BMI, centers = 2)$cluster)

bmi_c %>% 
  arrange(BMI) %>% 
  filter(BMI == max(BMI[cluster == 1]))

```

A kmeans clustering approach splits both groups at around BMI = 22.5. This should further reiforce the 22 threshold.

# STratification by BMI at baseline

Now we found a threshold appropiate to split by BMI, we can stratify the population by treatment and bmi, vs gene richness.


```{r BL_stratified_analysis, warning = F, message = F}

bmi_c %>% 
  dplyr::mutate(BMI_c = case_when(
    BMI >= 22 ~ "high",
    BMI < 22 ~ "low"
  )) %>% 
  
  # dplyr::mutate(group_bmi = paste(cat_var, BMI_c)) %>% 
  ggplot(aes(x = cat_var, y = richness, fill = BMI_c)) +
  geom_boxplot() + 
  ggpubr::stat_compare_means(method = "wilcox.test", hide.ns = F) +
  theme_light()


bmi_c %>% 
  # dplyr::select(BMI, richness) %>% 
  dplyr::filter(!is.na(richness)) %>% 
  mutate(new_c = kmeans(.[,c("BMI","richness")], centers = 2)$cluster) %>% 
  ggplot(aes( x = BMI, y = richness, color = as.factor(new_c))) +
  geom_point() +
  theme_light()

```
Doesn't seem to be any noticeable difference between groups or BMI types. No diferences richness between HBMI and LBMI could be found. 


# Stratification by BMI changes

Maybe the increase in gene richness may be associated with higher increase in BMI

```{r, eval = T, warning = F, message = F}

delta_bmi_df <- 
igc_df %>% 
  # dplyr::filter(long_var == 0) %>% 
  dplyr::select(link_var, long_var, cat_var, richness, BMI) %>% 
  group_by(link_var) %>% 
  dplyr::filter(long_var %in% c(0,96), 
                !is.na(BMI)) %>% 
  filter(n() ==2) %>% 
  mutate(bmi0 = BMI[long_var == 0],
         gr0 = richness[long_var == 0],
    delta_BMI_abs = BMI - BMI[long_var == 0],
         delta_BMI_rel = (BMI - BMI[long_var == 0])*100 / BMI[long_var == 0],
         delta_gr_abs = richness - richness[long_var == 0],
         delta_gr_rel = (richness - richness[long_var == 0]) / (richness + richness[long_var == 0])) %>%
  dplyr::filter(long_var == 96) %>% 
  dplyr::select(record_id = link_var, contains("delta"), bmi0, gr0, cat_var) 


peaks_abs <-
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(cat_var == treat) %>% 
      dplyr::pull(delta_BMI_abs) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(cat_var = treat)
  })


plot_delta_abs <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_abs)) +
  geom_density(aes(color = cat_var)) +
  geom_vline(aes(color = cat_var), xintercept = peaks_abs$x, lty = 3) +
  geom_text(data = peaks_abs, aes(x = peaks_abs$x, y = peaks_abs$y*.9,label = peaks_abs$x, color = cat_var)) +
  theme_light() +
  labs(title = "Absolute", x = "BMI increase") 




peaks_rel <- 
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(cat_var == treat) %>% 
      dplyr::pull(delta_BMI_rel) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(cat_var = treat)
  })

plot_delta_rel <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_rel,color = cat_var)) +
  geom_density(aes(color = cat_var)) +
  geom_vline(data = peaks_rel, aes(color = cat_var), xintercept = peaks_rel$x, lty = 3) +
  geom_text(data = peaks_rel, aes(x = x, y = y*.9,label = x, color = cat_var)) +
  labs(title = "Relative (%)", x = "BMI increase") +
  theme_light()+
  theme(axis.title.y = element_blank())


# delta_bmi_df %>% 



ggpubr::ggarrange(plot_delta_abs, plot_delta_rel, common.legend = T)  


```

Both treatment groups appear to have a unimodal distribution regarding their BMI increase at week 96, both in absolute and relative terms. However there seems to be a shift between both, as the "valley" between both peaks in the DTG group seems to be shifted toward the left, relative to the DRV group.

A good threshold to separate two groups seems to be 2.5 increase of absolute BMI. It separates both peaks from each group, more or less equitatively.


```{r delta_cors, warning=FALSE, message=F}
test_gr0_abs <-
  delta_bmi_df %>%
  glm(delta_BMI_abs ~ gr0 * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3L) %>% 
  pull(p)

deltas_gr0_abs <- 
  delta_bmi_df %>% 
  ggplot(aes(x = gr0, y = delta_BMI_abs, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  labs(title = "Absolute", subtitle = paste("ANOVA p =", test_gr0_abs),x = "Gene richness at baseline") +
  theme_light()


test_gr0_rel <-
  delta_bmi_df %>%
  glm(delta_BMI_rel ~ gr0 * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3) %>% 
  pull(p)

deltas_gr0_rel <- 
  delta_bmi_df %>% 
  ggplot(aes(x = gr0, y = delta_BMI_rel, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  theme_light() +
  labs(title = "Relative", subtitle = paste("ANOVA p =", test_gr0_rel),x = "Gene richness at baseline") +
  theme(axis.title.y = element_blank())



ggpubr::ggarrange(deltas_gr0_abs, deltas_gr0_rel, common.legend = T)



test_gr_abs <-
  delta_bmi_df %>%
  glm(delta_BMI_abs ~ delta_gr_abs * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3L) %>% 
  pull(p)

deltas_gr_abs <- 
  delta_bmi_df %>% 
  ggplot(aes(x = delta_gr_abs, y = delta_BMI_abs, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  labs(title = "Absolute", subtitle = paste("ANOVA p =", test_gr_abs), x = "Gene richness increase") +
  theme_light()


test_gr_rel <-
  delta_bmi_df %>%
  glm(delta_BMI_rel ~ delta_gr_rel * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3) %>% 
  pull(p)

deltas_gr_rel <- 
  delta_bmi_df %>% 
  ggplot(aes(x = delta_gr_rel, y = delta_BMI_rel, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  theme_light() +
  labs(title = "Relative", subtitle = paste("ANOVA p =", test_gr_rel),x = "Gene richness increase") +
  theme(axis.title.y = element_blank())



ggpubr::ggarrange(deltas_gr_abs, deltas_gr_rel, common.legend = T)

```




# Stratifying population by BMI

Now that we saw the increase in gene richness follows a bimodal distribution in each group, it is possible that we didn't find an effect of gene richness per treatment group due to the confusor effect of BMI. We will split the population between high BMI change (BMI_H) and low BMI increase (BMI_L). The cutting point will be an absolute increase of 2.5 in BMI, as seen earlier in the delta distribution.


```{r bmi_stratification, warning=F, message=FALSE}
delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 2.5 ~ "H_BMI",
    delta_BMI_abs < 2 ~ "L_BMI"
  )) %>% 
  # dplyr::select(link_var = record_id, bmi_c) %>% 
  # left_join(igc_df, by = "link_var") %>% 
  # mutate(cat_var2 = paste(cat_var, bmi_c)) %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  ggplot(aes(y = gr0, x = cat_var, fill = bmi_c)) +
  ggpubr::stat_compare_means(method = "wilcox.test") +
  geom_boxplot()




```




