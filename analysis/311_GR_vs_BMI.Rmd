---
title: "BMI_stratification"
author: "Carlos Bl√°zquez Bondia"
date: "2023-03-06"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
source(here::here("code","LMM.R"))
source(here::here("code","myFunctions.R"))
source(here::here("code", "group_comparisons.R"))
library(ggalluvial)
library(RColorBrewer)
library(ggpubr)

```

```{r load_data, message=F, warning=F, echo=FALSE}

mymre <- here::here("data", "filt_mre.rds") %>% 
  readRDS()


metadata <-
  here::here("Metadata") %>% 
    list.files(pattern = "clean_metadata", full.names = T) %>%
  file.info() %>% 
  dplyr::arrange(desc(ctime)) %>% 
  rownames() %>% 
  dplyr::first() %>% 
  read.csv()
  
mymre@metadata@categorical_vals <- here::here("Metadata", "CategoricalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@numeric_vals <- here::here("Metadata", "NumericalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@longitudinal_vals <- here::here("Metadata", "LongitudinalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

cat_vector <- get_cat(mymre) %>% 
  pull(CategoricalVariable)

num_vector <- 
  get_num(mymre) %>% 
  pull(NumericalVariable)


```

```{r support_funs, warning=F, message=F, echo = F}
peak_finder <-
  function(density, goal = "max",keep = F) {
    ### Let's define this function heere but we'll use it later
    stopifnot("goal can only be either local maxima (use: 'max') or local minima (use 'min)" = goal %in% c("min","max"))
    
    val <- case_when(goal == "max" ~ -2,
                   goal == "min" ~ 2)
    
    res <-
      density %>%
      purrr::keep(names(.) %in% c("x", "y")) %>%
      as.data.frame() %>%
      dplyr::mutate(is_peak = c(F, # 1st value can't be a local maxima, as there is no prior value to compare
                                diff(y) %>% # For each nth element of the vector, get (n+1) - n
                                  sign() %>%  # convert to -1 (n+1 is lower than n) or +1 (n+1 is higher than n)
                                  diff() == val, # if n is at a local maxima, both n+1 and n-1 are negative so [(n+1)-n] - [n - (n-1)] is -2
                                F)) # Last element can't be a local maxima either)
                    
                    if (!keep) {
                      res %>%
                        dplyr::filter(is_peak) %>%
                        dplyr::select(-is_peak)
                    } else{
                      res %>%
                        dplyr::select(-is_peak)
                    }
  }


```

```{r read_GR, echo = F, warning=F, message=F, results='hide'}
igc<-metar::get_diversity(mymre)@igc
Threshold <-  igc@dataTable %>%
  dplyr::select(SampleID, NumberMappedReads) %>%
  unique() %>%
  summarise(Q = quantile(NumberMappedReads,0.02)) %>% 
  as.numeric()


igc_df <- igc@dataTable %>%
                dplyr::filter(NumberMappedReads >= Threshold) %>%
                dplyr::filter(ReadCountReal>=Threshold) %>% ### Get the Mapped Read count (per-sample) just above the threshold
                dplyr::group_by(SampleID) %>%
                dplyr::summarise(across(everything(), min)) %>%
                dplyr::ungroup() %>%
          dplyr::right_join(., metadata, by="SampleID") %>%
          dplyr::select(SampleID,
                 richness = GeneNumber,
                 link_var= record_id,
                 cat_var = group,
                 long_var = time_point,
                 NumberMappedReads, 
                 num_vector, 
                 height = height,
                 weight = weight) %>% 
  dplyr::mutate(sCD14 = as.numeric(sCD14),
         weight = case_when(link_var == "C007" & long_var == 48 ~ 69.7,
                            link_var == "D009" & long_var == 96 ~ 61.9,
                            link_var == "E008" & long_var == 0 ~ 39.1,
                            link_var == "D013" & long_var == 96 ~ 67,
                            TRUE ~ as.numeric(weight)),
         BMI = weight/((height/100)^2)) %>% 
  dplyr::mutate(group_bmi = factor(
    case_when(BMI < 18.5 ~ "underweight",
                                BMI >= 18.5 & BMI <=25 ~ "healthy_weight",
                                BMI > 25 ~ "overweight"),
    levels = c("underweight", "healthy_weight", "overweight")
    )) 


```

Stratification by BMI
=====================

This set of tests comes from recent studies which found that INSTIs are associated with greater BMI increases, respective to other treatments in ART-receiving patients. BMI is highly related to gut health, metabolism and microbiome, and may be a possible confussor regarding the interaction between treatment and microbiote, especially gene richness, as it may be masking the actual effect of treatment. The first is to assess how big of an impact our treatments have on the patients BMIs.

As we are looking strictly at BMI now, we'll use the entries for ALL participants included in the study, regardless of wether there are faecal samples in a certain timepoint or not.

```{r read_complete_BMI, warning = F, message = F}


all_bmis<- here::here("Metadata","MetadataManagement","Vital.xlsx") %>%
  readxl::read_excel() %>%
  filter(PatCode != "TMP??-000") %>%
  pivot_wider(id_cols = c("PatCode", "Week"),names_from="ParamName", values_from = "Result") %>%
  dplyr::rename(record_id = PatCode,
         time_point = Week,
         weight = Weight,
         height = Height) %>%
  mutate(time_point = as.numeric(time_point),
         record_id = gsub("-","",record_id),
         weight = case_when(record_id == "C007" & time_point == 48 ~ 69.7,
                            record_id == "D009" & time_point == 96 ~ 61.9,
                            record_id == "E008" & time_point == 0 ~ 39.1,
                            record_id == "D013" & time_point == 96 ~ 67,
                            record_id == "E004" & time_point == 24 ~ 68.1,
                            TRUE ~ as.numeric(weight)))  %>%
  relocate(record_id, time_point,weight, height, BMI) %>% 
  dplyr::filter(record_id %in% metadata$record_id,
                time_point %in% c(0,24,48,96)) %>% 
  dplyr::mutate(across(everything(), ~ str_replace_all(.x, "^[[.]]$|^$", NA_character_)),
                weight = as.numeric(weight),
                height = as.numeric(height)) %>%  
  dplyr::mutate(BMI = weight/((height/100)^2)) %>% 
  complete(., record_id,time_point) %>% 
  left_join(unique(metadata[,c("record_id","group")]), by = "record_id") %>% 
  mutate(SampleID = as.factor(seq(1:nrow(.))),
         group_bmi = factor(
                      case_when(BMI < 18.5 ~ "underweight",
                                                  BMI >= 18.5 & BMI <=25 ~ "healthy_weight",
                                                  BMI > 25 ~ "overweight"),
                      levels = c("underweight", "healthy_weight", "overweight")
                      )) 

all_bmis %>% 
 ggplot(aes(x = record_id, y = BMI)) +
  geom_point() +
  geom_text(aes(label = record_id))


```


```{r BMI-vs_group, warning=FALSE, message=FALSE}

all_bmis %>% 
  dplyr::select(SampleID,record_id, group, time_point, BMI) %>% 
  dplyr::mutate(time_point = as.numeric(time_point)) %>% 
  get_lmm_effects(.,cat_vector = "group", num_vector = "BMI", long_var = "time_point", link_var = "record_id", title = "BMI evolution/group") %>% 
  purrr::pluck("group","BMI","plot") +
  scale_color_manual(values = c("black","grey")) +
  scale_linetype_manual(labels = c("DTG", "DRV"),values = c(1,2))
  

require(rstatix)
bmi_test <- 
get_comp_boxplots(dat = all_bmis, cat_var = "group", num_var = "BMI", long_var = "time_point", link_var = "record_id", pal = "Accent") 


bmi_test$plot +
  labs(color = "group") +
  scale_fill_manual(values = c("black","grey"))

bmi_test$test$cat %>% 
  dplyr::select(long_var, contains ( "group"), p.adj.signif) %>% 
  kableExtra::kable(format = "markdown")


```

Turns out looking at BMI alone, no categorical differences can be found. While both treatment groups significantly increase in BMI, no diferences between DTG an DRV are found.

Anyhow, this may have something to do with BMI differences at BL. Let's check for its distribution:

```{r basal_dist_df, warning=F, message=FALSE}
peaks_bl <- all_bmis %>% 
  dplyr::filter(time_point == 0, !is.na(BMI)) %>% 
  dplyr::pull(BMI) %>%
  density() %>% 
  peak_finder(goal = "max")

median_bl <- all_bmis %>% 
  dplyr::filter(time_point == 0, !is.na(BMI)) %>% 
  dplyr::pull(BMI) %>% 
  median()

all_bmis %>% 
  dplyr::filter(time_point == 0, !is.na(BMI)) %>% 
  ggplot(.) +
  # geom_histogram(aes(x = BMI), fill = "grey", bins = 100) +
  geom_density(aes(x = BMI, color = group),bins = 100) +
  theme_bw() +
  geom_vline(xintercept = peaks_bl$x, lty = 3) +
  geom_vline(xintercept = median_bl, col = "red") +
  geom_text(data = peaks_bl, aes(x = x, y = y*.9, label = round(x, 3))) +
  geom_text(aes(x = median_bl, y = max(peaks_bl$y)*.5, label = round(median_bl,3))) +
  labs(x = "BMI", y = "kernel density", title = "BMI distribution at baseline") +
  theme(axis.title.y = element_blank()) +
  scale_color_manual(values = c("black","grey"))




```

It seems there is a certain bimodality in the distribution of BMI at BL in the DTG, in which a peak of patients emerges around BMI of 28. Anyway, both groups have their peaks farily close to the overall median, and their distributions, especially in the bDRV group approaches normality. The overall median is 22.064, which is well within the healthy weight.

-   18.5 (Underweight)
-   18.5 to 25 (healthy weight).
-   25 (overweight)


The total number of patients in each group at basal is as follows

```{r print_bmi_table, echo = F, message=FALSE, warning=FALSE}

all_bmis %>% 
  dplyr::filter(time_point == 0, !is.na(BMI))%>% 
  # nest_by(cat_var) %>% 
  compareGroups::compareGroups(formula = group ~ group_bmi) %>% 
  compareGroups::createTable(.) %>% 
  compareGroups::export2md()

```

As we can see, the majority of the cohort is within the range of healthy weight and both groups are pretty well balanced at baseline. This sets a good statistical base from which to find signals after treatment.

# Longitudinal evolution of BMI

Before entering in the complexities of gut microbiota, we'll assess wether DTG/bDRV have a differential effect on the chances of patients changing BMI categories. A good way to visualize this will be an alluvial plot.

```{r alluvial_plot}
all_bmis %>% 
  dplyr::mutate(group_bmi = replace(group_bmi, "No data"))
  # dplyr::filter(!is.na(group_bmi)) %>% 
  # arrange(cat_var) %>% 
  ggplot(aes(x = as.factor(time_point), stratum = group_bmi, label = group_bmi, fill = group_bmi,alluvium = record_id, )) +
  facet_wrap(facets = ~ group) +
  geom_flow(stat = "alluvium",  na.rm = F, width = 0.4, color = "black") +
  geom_text(stat = "alluvium", aes(label = record_id, color = group_bmi), size = 4) +
  scale_color_manual(values= c("black","black","white", "white")) +
  theme_minimal() +
  scale_fill_manual(values = c("white","lightblue","black")) +
  labs(x = "weeks", fill = "BMI category") +
  theme(strip.background = element_rect(color = "black"),
        axis.line = element_line(colour = "black"),
        panel.border = element_rect(color = "black", fill = NA)
          ) +
  guides(color = "none")
```


In the bDRV group only a 


GR Stratification by BMI at baseline
====================================

Now it is time to assess whether the BMI category may be affecting/be influenced by gene richness. 

### GR vs BMI correlation at baseline
Now we found a threshold appropiate to split by BMI, we can stratify the population by treatment and bmi, vs gene richness.

```{r BL_, warning = F, message = F}

bmi_c %>% 
  dplyr::mutate(BMI_c = case_when(
    BMI >= 22 ~ "high",
    BMI < 22 ~ "low"
  )) %>% 
  
  # dplyr::mutate(group_bmi = paste(cat_var, BMI_c)) %>% 
  ggplot(aes(x = cat_var, y = richness, fill = BMI_c)) +
  geom_boxplot() + 
  ggpubr::stat_compare_means(method = "wilcox.test", hide.ns = F) +
  theme_light()


bmi_c %>% 
  # dplyr::select(BMI, richness) %>% 
  dplyr::filter(!is.na(richness)) %>% 
  mutate(new_c = kmeans(.[,c("BMI","richness")], centers = 2)$cluster) %>% 
  ggplot(aes( x = BMI, y = richness, color = as.factor(new_c))) +
  geom_point() +
  theme_light()

```

Doesn't seem to be any noticeable difference between groups or BMI types. No diferences richness between HBMI and LBMI could be found.

Stratification by BMI changes
=============================

Maybe the increase in gene richness may be associated with higher increase in BMI

vs GR BL
--------

```{r delta_cors_BL, warning=FALSE, message=F}
delta_bmi_df <- 
    igc_df %>% 
      dplyr::filter(!is.na(richness), !is.na(BMI)) %>%
      group_by(link_var) %>% 
  dplyr::filter(any(long_var == 0),
                any(long_var == 96)) %>% 
      mutate(bmi0 = BMI[long_var == 0],
         gr0 = richness[long_var == 0],
    delta_BMI_abs = BMI - BMI[long_var == 0],
         delta_BMI_rel = (BMI - BMI[long_var == 0])*100 / BMI[long_var == 0],
         delta_gr_abs = richness - richness[long_var == 0],
         delta_gr_rel = (richness - richness[long_var == 0]) / (richness + richness[long_var == 0])) %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs[long_var == 96] >= 2.5 ~ "H_BMI",
    delta_BMI_abs[long_var == 96]  < 2.5 ~ "L_BMI"
  )) %>% 
  dplyr::mutate(bmi_c_g = paste(bmi_c, cat_var, sep = "_"))


test_gr0_abs <-
  delta_bmi_df %>%
  glm(delta_BMI_abs ~ gr0 * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3L) %>% 
  pull(p)

deltas_gr0_abs <- 
  delta_bmi_df %>% 
  ggplot(aes(x = gr0, y = delta_BMI_abs, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  labs(title = "Absolute", subtitle = paste("ANOVA p =", test_gr0_abs),x = "Gene richness at baseline") +
  theme_light() +
  scale_color_brewer(palette = "Accent") +
  scale_fill_brewer(palette = "Accent") 


test_gr0_rel <-
  delta_bmi_df %>%
  glm(delta_BMI_rel ~ gr0 * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3) %>% 
  pull(p)

deltas_gr0_rel <- 
  delta_bmi_df %>% 
  ggplot(aes(x = gr0, y = delta_BMI_rel, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  theme_light() +
  labs(title = "Relative", subtitle = paste("ANOVA p =", test_gr0_rel),x = "Gene richness at baseline") +
  theme(axis.title.y = element_blank()) +
  scale_color_brewer(palette = "Accent") +
  scale_fill_brewer(palette = "Accent") 



ggpubr::ggarrange(deltas_gr0_abs, deltas_gr0_rel, common.legend = T)

```

No correlation could be found relating

vs GR change
------------

```{r plot_distributions_96, eval = T, warning = F, message = F}

tp <- 96



peaks_abs <-
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(cat_var == treat) %>% 
      dplyr::pull(delta_BMI_abs) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(cat_var = treat)
  })


plot_delta_abs <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_abs)) +
  geom_density(aes(color = cat_var)) +
  geom_vline(aes(color = cat_var), xintercept = peaks_abs$x, lty = 3) +
  geom_text(data = peaks_abs, aes(x = peaks_abs$x, y = peaks_abs$y*.9,label = peaks_abs$x, color = cat_var)) +
  theme_light() +
  labs(title = "Absolute", x = "BMI increase") 




peaks_rel <- 
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(cat_var == treat) %>% 
      dplyr::pull(delta_BMI_rel) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(cat_var = treat)
  })

plot_delta_rel <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_rel,color = cat_var)) +
  geom_density(aes(color = cat_var)) +
  geom_vline(data = peaks_rel, aes(color = cat_var), xintercept = peaks_rel$x, lty = 3) +
  geom_text(data = peaks_rel, aes(x = x, y = y*.9,label = x, color = cat_var)) +
  labs(title = "Relative (%)", x = "BMI increase") +
  theme_light()+
  theme(axis.title.y = element_blank())


# delta_bmi_df %>% 



ggpubr::ggarrange(plot_delta_abs, plot_delta_rel, common.legend = T)  


```

Both treatment groups appear to have a unimodal distribution regarding their BMI increase at week 96, both in absolute and relative terms. However there seems to be a shift between both, as the "valley" between both peaks in the DTG group seems to be shifted toward the left, relative to the DRV group.

A good threshold to separate two groups seems to be 2.5 increase of absolute BMI. It separates both peaks from each group, more or less equitatively.

```{r lmms_deltas, message = F, warning = F}
test_gr_abs <-
  delta_bmi_df %>%
  glm(delta_BMI_abs ~ delta_gr_abs * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3L) %>% 
  pull(p)

deltas_gr_abs <- 
  delta_bmi_df %>% 
  ggplot(aes(x = delta_gr_abs, y = delta_BMI_abs, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  labs(title = "Absolute", subtitle = paste("ANOVA p =", test_gr_abs), x = "Gene richness increase") +
  theme_light() +
  scale_color_brewer(palette = "Accent") +
  scale_fill_brewer(palette = "Accent") 


test_gr_rel <-
  delta_bmi_df %>%
  glm(delta_BMI_rel ~ delta_gr_rel * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3) %>% 
  pull(p)

deltas_gr_rel <- 
  delta_bmi_df %>% 
  ggplot(aes(x = delta_gr_rel, y = delta_BMI_rel, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  theme_light() +
  labs(title = "Relative", subtitle = paste("ANOVA p =", test_gr_rel),x = "Gene richness increase") +
  theme(axis.title.y = element_blank()) +
  scale_color_brewer(palette = "Accent") +
  scale_fill_brewer(palette = "Accent") 





ggpubr::ggarrange(deltas_gr_abs, deltas_gr_rel, common.legend = T)

```

Stratifying population by BMI
=============================

We know from previous analysis that the biggest differences in GR beween grups happened at week 24: \#\# Week 24

```{r GR_group_boxplots, warning = F, message = F}

cat_test <-
    obj <-
  delta_bmi_df %>%
  dplyr::filter(!is.na(richness)) %>%
  group_by(long_var) %>%
  get_group_comparisons(
    .,
    link_var = "link_var",
    long_var = "long_var",
    cat_vector = "bmi_c_g",
    num_vector = "richness",
    type = "categorical",
    comps = unique(delta_bmi_df$bmi_c_g),
    graph_coords = T
  )

objtest <- obj %>% pluck("bmi_c_g", "richness", "test")
objstats <- obj %>% pluck("bmi_c_g", "richness", "stats") %>%
  mutate(stat = paste(round(median, 2), " [", round(iqr, 2), "]", sep = ""))

cat_test_df <- 
objtest %>%
  pivot_longer(cols = c("group1", "group2")) %>%
  dplyr::rename(cat_var = value) %>%
  dplyr::left_join(objstats[, c("cat_var", "long_var", "stat")], by = c("cat_var", "long_var")) %>%
  pivot_wider(names_from = "name",
              values_from = c("cat_var", "stat")) %>%
  dplyr::select(long_var,
                group1 = cat_var_group1,
                group2 = cat_var_group2,
                contains("stat"),
                y.position,
                xmin,xmax,
                p.adj,
                p.adj.signif)


long_test <- 
combn(unique(delta_bmi_df$long_var), 2, simplify = F) %>% 
  purrr::set_names() %>% 
  purrr::map_dfr(function(comb){
    
    obj <- 
    delta_bmi_df %>% 
      dplyr::filter(!is.na(richness),
                    long_var %in% comb) %>% 
      # group_by(bmi_c_g) %>% 
      get_group_comparisons(.,link_var = "link_var", long_var = "long_var",cat_vector = "bmi_c_g",num_vector = "richness",type = "longitudinal", comps = comb,graph_coords = T)
    
    obj %>% 
      pluck("bmi_c_g","richness","test") %>% 
      rstatix::adjust_pvalue( method = "BH", p.col = "p") %>% 
      full_join(obj$bmi_c_g[["richness"]]$stats, by = "cat_var")%>% 
      dplyr::mutate(.y. = "richness") %>% 
      dplyr::select(cat_var, group1, group2,num_var = .y.,y.position, xmin, xmax, contains("median"), contains("iqr"), "p.adj") 
  })%>% 
      rstatix::add_significance()



summ_df <- 
delta_bmi_df %>% 
  dplyr::group_by(long_var,bmi_c, cat_var, bmi_c_g) %>% 
  summarise(median_gr = median(richness),
            sd_gr = sd(richness))




spaghetti_plot_list <- 
    igc_df %>%
      # dplyr::filter(!is.na(!!sym(nv)), !is.na(bmi_c_g)) %>%
      mutate(long_var = as.factor(long_var)) %>%
      ggplot(aes(
        x = long_var,
        y = richness,
        color = bmi_c_g
      )) +
      geom_point(
        data = summ_df,
        aes(
          x = as.factor(long_var),
          y = median_gr,
          color = cat_var,
          shape = bmi_c,
          group = bmi_c_g
        ),
        size = 3,
        position = position_dodge(.8)
      ) +
      
      geom_errorbar(
        data = summ_df,
        aes(
          x = as.factor(long_var),
          ymin = median_gr - sd_gr,
          ymax = median_gr + sd_gr,
          color = cat_var,
          lty = bmi_c,
          group = bmi_c_g
        ),
        inherit.aes = F,
        width = 1,
        position = position_dodge(.8)
      ) +
      geom_line(
        data = summ_df,
        aes(
          x = as.factor(long_var),
          y = median_gr,
          color = cat_var,
          lty = bmi_c,
          group = bmi_c_g
        ),
        inherit.aes = F,
        position = position_dodge(.8)
      ) +
      # stat_smooth(method = "loess", alpha = .2, aes(fill = cat_var), position = position_dodge(.8)) +
      theme_bw() +
      labs(
        x = "weeks",
        y = "richness",
        color = "group",
        shape = "BMI increase",
        lty = "BMI increase",
        title = "richness vs BMI increase"
      ) +
      ggpubr::stat_pvalue_manual(cat_test_df, label = "p.adj.signif", hide.ns = T) +
      ggpubr::stat_pvalue_manual(long_test, label = "p.adj.signif", hide.ns = T) +
      scale_color_brewer(palette = "Dark2") +
      scale_fill_brewer(palette = "Dark2") +
      theme(axis.title.x = element_blank())
    # scale_x_continuous(breaks = c(0,48,96))

spaghetti_plot_list %>%
ggsave(plot= ., device = "svg",path = here::here("output","figures"), filename = "bmi_richness.svg", dpi= 300, width = 15, height = 25, units = "cm")

spaghetti_plot_list


  
```

Apparently, the only significant differences are between both subgroups belonging to the DTG arm, this suggests the GR change relates more to group rather than BMI.

```{r stat_Tables, warning F, message=FALSE, echo = F}
long_test %>% 
  dplyr::filter(p.adj <0.05) %>% 
  dplyr::select(arm = cat_var, contains("group"), median1, iqr1, median2, iqr2, medianChange, iqr_change, p.adj) %>% 
  kableExtra::kable(format = "markdown") 

cat_test_df %>% 
  dplyr::filter(p.adj < 0.05)
```

```{r plot_distributions, eval = T, warning = F, message = F, echo = F}

tp <- 24

delta_bmi_df <- 
igc_df %>% 
  # dplyr::filter(long_var == 0) %>% 
  dplyr::select(link_var, long_var, cat_var, richness, BMI) %>% 
  group_by(link_var) %>% 
  dplyr::filter(long_var %in% c(0,tp), 
                !is.na(BMI)) %>% 
  filter(n() ==2) %>% 
  mutate(bmi0 = BMI[long_var == 0],
         gr0 = richness[long_var == 0],
    delta_BMI_abs = BMI - BMI[long_var == 0],
         delta_BMI_rel = (BMI - BMI[long_var == 0])*100 / BMI[long_var == 0],
         delta_gr_abs = richness - richness[long_var == 0],
         delta_gr_rel = (richness - richness[long_var == 0]) / (richness + richness[long_var == 0])) %>%
  dplyr::filter(long_var == tp) %>% 
  dplyr::select(record_id = link_var, contains("delta"), bmi0, gr0, cat_var) 


peaks_abs <-
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(cat_var == treat) %>% 
      dplyr::pull(delta_BMI_abs) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(cat_var = treat)
  })


plot_delta_abs <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_abs)) +
  geom_density(aes(color = cat_var)) +
  geom_vline(aes(color = cat_var), xintercept = peaks_abs$x, lty = 3) +
  geom_text(data = peaks_abs, aes(x = peaks_abs$x, y = peaks_abs$y*.9,label = peaks_abs$x, color = cat_var)) +
  theme_light() +
  scale_color_brewer(palette = "Accent") +
  labs(title = "Absolute", x = "BMI increase", subtitle = paste("Week",tp), color = "group") 




peaks_rel <- 
  unique(metadata$group) %>%
  purrr::set_names() %>%
  purrr::map_dfr(function(treat) {
    
    delta_bmi_df %>%
      dplyr::filter(cat_var == treat) %>% 
      dplyr::pull(delta_BMI_rel) %>%
      density() %>%
      peak_finder(goal = "min") %>%
      round(., 3) %>% 
      mutate(cat_var = treat)
  })

plot_delta_rel <- 
delta_bmi_df %>% 
  ggplot(aes(x = delta_BMI_rel,color = cat_var)) +
  geom_density(aes(color = cat_var)) +
  geom_vline(data = peaks_rel, aes(color = cat_var), xintercept = peaks_rel$x, lty = 3) +
  geom_text(data = peaks_rel, aes(x = x, y = y*.9,label = x, color = cat_var)) +
  labs(title = "Relative (%)", x = "BMI increase", subtitle = paste("Week",tp), color = "group") +
  theme_light()+
  scale_color_brewer(palette = "Accent") +
  theme(axis.title.y = element_blank())


# delta_bmi_df %>% 



ggpubr::ggarrange(plot_delta_abs, plot_delta_rel, common.legend = T)  


```

Here it appears the threshold should be un BMI increase of 1.3, let's do that:

```{r delta_cors, warning=FALSE, message=F, echo = F}
test_gr0_abs <-
  delta_bmi_df %>%
  glm(delta_BMI_abs ~ gr0 * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3L) %>% 
  pull(p)

deltas_gr0_abs <- 
  delta_bmi_df %>% 
  ggplot(aes(x = gr0, y = delta_BMI_abs, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  labs(title = "Absolute", subtitle = paste("ANOVA p =", test_gr0_abs),x = "Gene richness at baseline") +
  theme_light()


test_gr0_rel <-
  delta_bmi_df %>%
  glm(delta_BMI_rel ~ gr0 * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3) %>% 
  pull(p)

deltas_gr0_rel <- 
  delta_bmi_df %>% 
  ggplot(aes(x = gr0, y = delta_BMI_rel, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  theme_light() +
  labs(title = "Relative", subtitle = paste("ANOVA p =", test_gr0_rel),x = "Gene richness at baseline") +
  theme(axis.title.y = element_blank())



ggpubr::ggarrange(deltas_gr0_abs, deltas_gr0_rel, common.legend = T)



test_gr_abs <-
  delta_bmi_df %>%
  glm(delta_BMI_abs ~ delta_gr_abs * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3L) %>% 
  pull(p)

deltas_gr_abs <- 
  delta_bmi_df %>% 
  ggplot(aes(x = delta_gr_abs, y = delta_BMI_abs, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  labs(title = "Absolute", subtitle = paste("ANOVA p =", test_gr_abs), x = "Gene richness increase") +
  theme_light()


test_gr_rel <-
  delta_bmi_df %>%
  glm(delta_BMI_rel ~ delta_gr_rel * cat_var, data = .) %>%
  rstatix::anova_test() %>% 
  as.tibble() %>% 
  dplyr::slice(3) %>% 
  pull(p)

deltas_gr_rel <- 
  delta_bmi_df %>% 
  ggplot(aes(x = delta_gr_rel, y = delta_BMI_rel, color = cat_var)) +
  geom_point() +
  geom_smooth(method = "glm", aes(fill = cat_var)) +
  theme_light() +
  labs(title = "Relative", subtitle = paste("ANOVA p =", test_gr_rel),x = "Gene richness increase") +
  theme(axis.title.y = element_blank())



ggpubr::ggarrange(deltas_gr_abs, deltas_gr_rel, common.legend = T)

```

```{r bmi_stratification, warning=F, message=FALSE, echo = F}
delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 1.3 ~ "H_BMI",
    delta_BMI_abs < 1.3 ~ "L_BMI"
  )) %>% 
  # dplyr::select(link_var = record_id, bmi_c) %>% 
  # left_join(igc_df, by = "link_var") %>% 
  # mutate(cat_var2 = paste(cat_var, bmi_c)) %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  ggplot(aes(y = gr0, x = cat_var, fill = bmi_c)) +
  ggpubr::stat_compare_means(method = "wilcox.test") +
  geom_boxplot() +
  theme_bw() +
  labs(x = "treatment", y = "gene richness (baseline)", fill = "BMI")


delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 1.3 ~ "H_BMI",
    delta_BMI_abs < 1.3 ~ "L_BMI"
  )) %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  ggplot(aes(y = delta_gr_rel, x = cat_var, fill = bmi_c)) +
  ggpubr::stat_compare_means(method = "wilcox.test") +
  geom_boxplot() +
  theme_bw() +
  labs(x = "treatment", y = "GR increase at week 24 (%)", fill = "BMI")


delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 1.3 ~ "H_BMI",
    delta_BMI_abs < 1.3 ~ "L_BMI"
  )) %>% 
  dplyr::select(record_id, bmi_c) %>% 
  dplyr::rename(link_var = record_id) %>% 
  dplyr::right_join(igc_df, by = "link_var") %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  dplyr::mutate(group_bmi = paste(cat_var, bmi_c, sep = "_")) %>% 
  group_by(group_bmi) %>% 
  rstatix::wilcox_test(richness ~ long_var) %>% 
  dplyr::filter(p < 0.05) %>% 
  kableExtra::kable(format = "markdown")


```

Week 96
-------

Now that we saw the increase in gene richness follows a bimodal distribution in each group, it is possible that we didn't find an effect of gene richness per treatment group due to the confusor effect of BMI. We will split the population between high (BMI\_H) and low BMI increase (BMI\_L). The cutting point will be an absolute increase of 2.5 in BMI, as seen earlier in the delta distribution.

```{r bmi_stratification_96, warning=F, message=FALSE}
delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 2.5 ~ "H_BMI",
    delta_BMI_abs < 2.5 ~ "L_BMI"
  )) %>% 
  # dplyr::select(link_var = record_id, bmi_c) %>% 
  # left_join(igc_df, by = "link_var") %>% 
  # mutate(cat_var2 = paste(cat_var, bmi_c)) %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  ggplot(aes(y = gr0, x = cat_var, fill = bmi_c)) +
  ggpubr::stat_compare_means(method = "wilcox.test") +
  geom_boxplot() +
  theme_bw() +
  labs(x = "treatment", y = "gene richness (baseline)", fill = "BMI")


delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 2.5 ~ "H_BMI",
    delta_BMI_abs < 2.5 ~ "L_BMI"
  )) %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  ggplot(aes(y = delta_gr_rel, x = cat_var, fill = bmi_c)) +
  ggpubr::stat_compare_means(method = "wilcox.test") +
  geom_boxplot() +
  theme_bw() +
  labs(x = "treatment", y = "GR increase at week 96 (%)", fill = "BMI")


delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 2.5 ~ "H_BMI",
    delta_BMI_abs < 2.5 ~ "L_BMI"
  )) %>% 
  dplyr::select(record_id, bmi_c) %>% 
  dplyr::rename(link_var = record_id) %>% 
  dplyr::right_join(igc_df, by = "link_var") %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  dplyr::mutate(group_bmi = paste(cat_var, bmi_c, sep = "_")) %>% 
  group_by(group_bmi) %>% 
  rstatix::wilcox_test(richness ~ long_var)


delta_bmi_df %>% 
  dplyr::mutate(bmi_c = case_when(
    delta_BMI_abs >= 2.5 ~ "H_BMI",
    delta_BMI_abs < 2.5 ~ "L_BMI"
  )) %>% 
  dplyr::select(record_id, bmi_c) %>% 
  dplyr::rename(link_var = record_id) %>% 
  dplyr::right_join(igc_df, by = "link_var") %>% 
  dplyr::filter(!is.na(bmi_c)) %>% 
  dplyr::mutate(group_bmi = paste(cat_var, bmi_c, sep = "_")) %>% 
  ggplot(aes(y = richness, x = as.factor(long_var), color = group_bmi)) +
  geom_boxplot(aes(x = as.factor(long_var))) +
  ggpubr::stat_compare_means(method = "kruskal.test", hide.ns = F, label = "p.signif") +
  # geom_point() +
  geom_smooth(method = "glm", alpha = 0) +
  theme_bw() +
  labs(x = "week") 


```
