---
title: "Beta Diversity and NMDS"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r load_libraries,echo=FALSE, warning=F, message=FALSE}
library(metar)
library(phyloseq)
library(tidyverse)
library(vegan)
library(ggrepel)
library(cluster)
require(gridExtra)
library(ggpubr)
library(rstatix)
library(RColorBrewer)
source("code/basal_distances.R")
source("code/group_comparisons.R")
source("code/myFunctions.R")
```

## Including Plots

You can also embed plots, for example:

```{r load_metadata_vars, eval=T, message = F}
mymre <- here::here("data", "filt_mre.rds") %>% 
  readRDS()


metadata <-
  here::here("Metadata") %>% 
    list.files(pattern = "clean_metadata", full.names = T) %>%
  file.info() %>% 
  dplyr::arrange(desc(ctime)) %>% 
  rownames() %>% 
  dplyr::first() %>% 
  read.csv()


cat_df <- 
  here::here("Metadata", "CategoricalVariables.txt") %>% 
  read.delim(., header = T)

cat_vector <- cat_df %>% 
  pull(CategoricalVariable)

long_var <- here::here("Metadata", "LongitudinalVariables.txt") %>%
  read.delim(., header = T)  %>% 
  pull(LongitudinalVariable)

id_var <- here::here("Metadata", "LongitudinalVariables.txt") %>%
  read.delim(., header = T)  %>% 
  pull(LinkVariable)

num_var <- here::here("Metadata", "NumericalVariables.txt") %>%
  read.delim(., header = T)  %>% 
  pull(NumericalVariable)


```

```{r update_mre, warning= F, message= F, eval = F}

#### This chunk is for updating the mre internally as new variables come out. Once the final mre is done this chunk will be removed.
devtools::load_all("../WMGSPipeline")
mymre@taxa@virgo <- SpquantSet()
mymre@gene_function@humann <- metar::GeneFunSet()
mymre@taxa@metaphlan@phyloseq_sec

mymre <- filter_samples(mre = mymre, sample_ids = metadata$SampleID)

mymre@metadata@metadata_df <- tibble(metadata)

mymre@taxa@metaphlan@phyloseq@sam_data <- metadata %>%
  phyloseq::sample_data(.)
# 
# mymre@taxa@metaphlan@phyloseq_sec@sam_data <- metadata %>%
#   phyloseq::sample_data(.)


mymre@metadata@categorical_vals <- here::here("Metadata", "CategoricalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@numeric_vals <- here::here("Metadata", "NumericalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()

mymre@metadata@longitudinal_vals <- here::here("Metadata", "LongitudinalVariables.txt") %>% 
  read.delim(., header = T) %>% 
  tibble()



```

```{r Get_DistMats, eval=T, include=T, results = 'hide', eval = T}


phy <- get_phyloseq(mymre, type = "metaphlan")


getAbundances<-function(phyloseq, level){
  
  collapsedPhyloseq<- phyloseq::tax_glom(phyloseq, level)
  
  OtuTable<- phyloseq::otu_table(collapsedPhyloseq) %>%
    magrittr::set_rownames(as.character(phyloseq::tax_table(collapsedPhyloseq)[,level])) %>%
    as.data.frame()
  return(OtuTable)
  
}




myAbundanceDF<- getAbundances(phy, "Species")


myNMDS <- myAbundanceDF %>%
  t() %>% 
    as.data.frame() %>%
    # vegan::vegdist(., method = "bray") %>%
 
    metaMDS(.,trymax=800,  distance = "bray",
            k = 2)




NMDS_coords <- 
  myNMDS %>%
    pluck("points") %>%
    as.data.frame() 

  # NMDS = data.frame(NMDS1 = dim_NMDS$points[,1], NMDS2 = dim_NMDS$points[,2])

BiPlotCoords<- envfit(myNMDS, t(myAbundanceDF), perm=999) 


BiPlotCoordsDF <- c("NMDS1","NMDS2","r","pvals") %>%
  set_names() %>%
  
  map_dfr(., ~ {
    
    if(.x %in% c("NMDS1","NMDS2")){
      BiPlotCoords$vectors$arrows[,.x] %>%
        as.numeric()
    } else{
      BiPlotCoords$vectors %>%
        pluck(.x) %>%
        as.numeric()
    } 
      
  }) %>%
  as.data.frame() %>%
  set_names(nm=c("NMDS1","NMDS2","r","p")) %>%
  dplyr::mutate(Dim1 = NMDS1*sqrt(r),
                Dim2 = NMDS2*sqrt(r),
                species = rownames(myAbundanceDF)) 
  

myBrayDistMat <-vegdist(wisconsin(sqrt(t(myAbundanceDF))))


```

## NMDS by Treatment group

One of the variables: **CD4diff_96** has only one level. That means all patients in the study had an increase of CD4 counts higher than 50 cells/ml between weeks 96 and 0. As this variable only has one level it will cause the following code to break (as it performs conrast analysis). Hence, it will be removed from the following analysis. However, we'll look at the distribution of the CD4 increases as a distribution:

```{r NMDS_Group, warning= F, message= F, results='hide', eval = T}

cat_vector <- c("group", "group_bmi")
metadata <- metadata %>% 
    dplyr::mutate(group_bmi = factor(
    case_when(BMI < 18.5 ~ "underweight",
                                BMI >= 18.5 & BMI <=25 ~ "healthy_weight",
                                BMI > 25 ~ "overweight"),
    levels = c("underweight", "healthy_weight", "overweight")
    )) 



link_var <- "record_id"
id_var <- "SampleID"

BiPlotCoordsDF<-BiPlotCoordsDF %>%
  mutate(Dim1s = Dim1*3,
         Dim2s = Dim2*3)


  myNMDS_DF <- NMDS_coords %>%
  rownames_to_column(var = id_var) %>%
  dplyr::full_join(., metadata, by =id_var) %>%
  dplyr::select(SampleID = id_var,
                NMDS1 = MDS1,
                NMDS2 = MDS2,
                link_var = !!sym(link_var),
                cat_vector,
                long_var = long_var) %>% 
  dplyr::mutate(long_var = as.factor(long_var))


nmds_list <- 
cat_vector %>% 
  purrr::set_names() %>% 
  purrr::map(function(cv){
    
    
    cat_var <- cv
    
myNMDS_DF <- 
  myNMDS_DF %>% 
  dplyr::rename(cat_var := !!cv)


myAdonis<- adonis2(myBrayDistMat~ cat_var + long_var, data = myNMDS_DF, na.action = "na.exclude") %>%
  # pluck("aov.tab") %>%
  as.data.frame() %>%
  slice(c(1,2)) %>%
  magrittr::set_rownames(c(cat_var, "week"))




myNMDSplot<-
  myNMDS_DF %>% 
  dplyr::filter(!is.na(cat_var))%>%
  ggplot(., aes(x=NMDS1, y=NMDS2)) +
    geom_point(aes(color=cat_var)) +
    theme_bw()+
    stat_ellipse(alpha=1,aes(x=NMDS1, y=NMDS2, color = cat_var,linetype = long_var),lwd = .6,level=0.95)+
    # ggtitle(expression(atop("Species composition",atop(italic("all samples"))))) +
    coord_fixed()+
    labs(fill = cat_var, color=cat_var, lty = "time point")  +
    # scale_color_manual(values = c("#888888", "#000000")) +
    scale_linetype_manual(values = c(3,5,6,1),breaks = c("0","24","48","96")) +
    # scale_fill_manual(values = c("#888888", "#000000")) + 

    theme(panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),

          axis.line=element_line(colour="black"),
          axis.text.x=element_text(size=11),
          axis.text.y=element_text(size=11),
          axis.title.x=element_text(size=11),
          axis.title.y=element_text(size=11),

          legend.text=element_text(size=11,face="italic"),
          legend.title=element_text(size=11),
          legend.key.size = unit(1, "cm"),
          plot.title=element_text(lineheight=1,face="bold",size=13))+
    annotation_custom(gridExtra::tableGrob(round(myAdonis,3),
                                         theme = ttheme_default(base_size = 10)),ymin = 1.5)




myNMDSBiplot<-
  myNMDS_DF %>% 
    dplyr::filter(!is.na(cat_var))%>%

  ggplot(., aes(x=NMDS1, y=NMDS2)) +
    geom_point(aes(colour=cat_var, shape = as.character(long_var))) +
    # scale_colour_manual(values = myPal, labels = c("DGT", "DRV/r")) +
    # scale_fill_manual(values=myPal, labels = c("DGT", "DRV/r"))+
    theme_bw()+
    theme(panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),

          axis.line=element_line(colour="black"),
          axis.text.x=element_text(size=11),
          axis.text.y=element_text(size=11),
          axis.title.x=element_text(size=11),
          axis.title.y=element_text(size=11),

          legend.text=element_text(size=11,face="italic"),
          legend.title=element_text(size=11))+

    ggtitle(expression(atop("Species composition",atop(italic("all samples"))))) +
    theme(plot.title=element_text(lineheight=1,face="bold",size=13))+
    stat_ellipse(alpha=1,
                 aes(fill=cat_var, colour = cat_var),level=0.95)+
    # scale_size_manual(values = c(1:length(unique(myNMDS_DF[,"long_var"])))/1.5) +
    geom_segment(data=BiPlotCoordsDF,aes(x=0,xend=Dim1s,y=0,yend=Dim2s),
                 arrow = arrow(length = unit(0.2,"cm")),colour="darkgrey")+
    geom_text_repel(data=BiPlotCoordsDF,aes(Dim1s,Dim2s,label=species),
                    size=2.5, box.padding = unit(0.25, "lines"),
                    segment.colour="black",
                    segment.alpha=0.5,
                    segment.size=0.10)+
    coord_fixed()+
    labs(fill = cat_var, color=cat_var, shape = long_var) +
  annotation_custom(gridExtra::tableGrob(round(myAdonis,3),
                                         theme = ttheme_default(base_size = 8)),ymin = 3.5, xmin=2.4)


    return(list(plot = myNMDSplot, biplot = myNMDSBiplot))
  })





```

```{r Print_NMDS, message=F, warning=F}
myNMDSplot <- 
nmds_list$group$plot +
  scale_color_manual(values = c("#777777", "#000000"))

ggsave(myNMDSplot, filename = here::here("output", "figures","NMDS.svg"), device = "svg", width = 20, height = 18, units = "cm")
```

When we look at the most simple ordination before colouring by categorical variables, we see no clear separated clusters between samples. They all appear to be mostly concentrated in one big cluster that randomly spreads in the positive direction for both NMDS components.

### NMDS by group/bmi {.tabset}

#### ARM

```{r}
nmds_list$group$plot +
  scale_color_manual(values = c("#777777", "#000000"))

```

#### bmi category

```{r}
nmds_list$group_bmi$plot +
  scale_color_manual(values = c("#DDDDDD","#777777","#000000", "#FFFFFF"))


```

In a more formal analysis, the silhouette coefficient was tested for different number of clusters. This analysis found the biggest coefficient was found for n=1 clustrs, with massive drops between 2-3 and 5-6.

```{r silhouette_analysis, warning=F, message=F}




myBrayDistMat <- phyloseq::otu_table(phy) %>%
  t() %>%
  sqrt() %>%
  vegan::wisconsin() %>%
  vegan::vegdist()



c(1:11) %>%
  set_names() %>%
  map_df(., ~{
    cluster::pam(myBrayDistMat, k = .x) %>%
      pluck("silinfo") %>%
      pluck("avg.width")
  }) %>%
  t() %>%
  as_data_frame() %>%
  rownames_to_column(var="clusters") %>%
  set_names(c("clusters", "coefficient")) %>%
  ggplot(., aes(x=as.numeric(clusters), y=coefficient, group=1)) +
  geom_point() + 
  geom_line() + 
  scale_x_continuous(breaks=c(1:10)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) + 
  labs(title = "Silhouette coefficient by number of clusters", 
       x="nº Clusters", y = "Silhouette coefficient")
  

```

In the same fashion, when we start identifying samples by group and Timepoint, we see no clear separation, although samples from group 1 (+DGT) group appear to be more clustered together than group 2 (DRV+RLT), which show a more diffuse "central" cluster and are more dispersed. When looking at weight of the variables, the concentric spread of the arrows can be split in two sides, one more enriched in Prevotella and another in bacteroides, which spread mostly around the 2nd component of the NMDS.

However, the Adonis test found the variable group to have a significant effect over sample distances (p\<0.001), although it only accounted for a small portion of the variance

```{r plot_biplot, eval=F,include=T, message=F, warning=F}


myNMDSBiplot
```

# Longitudinal dispersion

We've seen that time point is the most significant variable in what comes to distance variance. It has been hypothesized that healthy human microbiomes tend to be somewhat similar, and when they become dysbiotic, they don't really change in a specific way, but each one does differently, kind of like "escaping from the healthy state". We'll call this the Anna Karenina principle, and we are going to check if this is happening in our cohort. As the immune system gets reconstituted, the gut microbiome should come from being scattered all over the ordination to get closer per group. We'll test this by calculating the distance of each sample to its NMDS group centroid. We'll do this by calculating the euclidean distance between each sample and the group centroid using the NMDS coordinates. This should not be really problematic as the NDS coordinates are already projected in a 2D space and hence the space should be euclidean.

The formula for the euclidean distance is the following: $$\sqrt{(x_c - x_s)² + (y_c -y_s)²}$$

```{r centroid_distances, warning=F, message=F}



centroids <- 
  myNMDS_DF %>% 
  dplyr::rename(cat_var = group) %>% 
  dplyr::mutate(long_cat = paste(cat_var, long_var, sep = "_")) %>% 
  envfit(myNMDS ~ cat_var * long_cat, ., perm = 999) %>% 
  purrr::pluck("factors","centroids") %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column(var = "long_cat") %>% 
  dplyr::mutate(long_var = str_extract(long_cat, "[0-9]+"),
                cat_var = str_extract(long_cat, "(bDRV|DTG)(?=_)")) %>% 
  dplyr::filter(!is.na(long_var), !is.na(cat_var))
                
NMDS_DF_c <- 
myNMDS_DF %>% 
  dplyr::mutate(long_var = as.character(long_var)) %>% 
  dplyr::right_join(centroids, by = c("cat_var", "long_var"), suffix = c("","_c")) %>% 
  dplyr::mutate(centroid_dist = sqrt((NMDS1_c-NMDS1)^2 + (NMDS2_c-NMDS2)^2)) %>% 
  select(-long_cat) %>% arrange(cat_var, long_var)


  
  
  
  
centroid_test_group <-
  NMDS_DF_c %>% 
  dplyr::mutate(cat_var = "overall") %>% 
  rbind(NMDS_DF_c) %>% 

  group_by(long_var) %>% 
  rstatix::wilcox_test(centroid_dist ~ cat_var) %>% 
  rstatix::add_significance("p") %>% 
  rstatix::add_xy_position(x = "long_var", group= "cat_var") %>% 
  dplyr::filter(!group1 == "overall", 
                !group2 == "overall")

centroid_test_long_oa <- 
  
  NMDS_DF_c %>% 
  PairedWilcox_withNAs(., Variable = "centroid_dist", Response = "long_var",Subsets = NULL,IDs = "link_var" ) %>% 
  dplyr::mutate(cat_var = "overall", .before = 1) %>% 
  # rstatix::wilcox_test(centroid_dist ~ cat_var, paired = T) %>% 
  rstatix::add_significance("p") 

centroid_test_long_group <- 
  NMDS_DF_c %>% 
  dplyr::mutate(cat_var = "overall") %>% 
  rbind(NMDS_DF_c) %>% 
  arrange(link_var, long_var) %>% 
  # get_group_comparisons(., link_var = "link_var", long_var = "long_var", cat_vector = "cat_var",num_vector = "centroid_dist",comps = c(0,24,48,96), graph_coords = T,type = "longitudinal")
  PairedWilcox_withNAs(., Variable = "centroid_dist", Response = "long_var",Subsets = "cat_var",IDs = "link_var" ) %>%
  dplyr::group_by(cat_var) %>% 
  rstatix::add_x_position(x = "long_var", group = "cat_var") %>% 
  rstatix::add_significance("p") %>% 
  ungroup() %>% 
  arrange(cat_var, long_var)
  # dplyr::filter(!p.signif == "ns")
  # rbind(centroid_test_long_oa) %>% 
  # rstatix::add_x_position(x = "long_var", group= c("cat_var"))
# 

cent_dist_plt <- 
NMDS_DF_c %>% 
  dplyr::mutate(long_var = as.factor(long_var),
         cat_var = "overall") %>% 
  rbind(NMDS_DF_c,.) %>% 
  ggplot(aes(x = long_var, y = centroid_dist)) +
  geom_boxplot(aes(color = cat_var), outlier.alpha = 0) +
  geom_jitter(aes(color = cat_var, group = cat_var, shape = cat_var), size = 1,
              position = position_jitterdodge(jitter.width = .1)) +
  stat_pvalue_manual(data = centroid_test_group, label = "p.signif", hide.ns = T, 
                     y = 1.8, bracket.size = .6, size = 6) +
  stat_pvalue_manual(data = centroid_test_long_group, label = "p.signif", 
                     hide.ns = T, 
                     y = c(2.5,2.7,2.9,3.2,3.4,3.6), bracket.size = .6, size = 6) +

  theme_minimal() +
  labs(x = "weeks", y = "centroid distance", color = "group", shape = "group") +
  scale_shape_manual(values = c(4,6,19), limits = c("bDRV", "DTG", "overall")) +
  scale_color_manual(values = c("#AAAAAA", "#555555", "#000000"), limits = c("bDRV", "DTG", "overall")) +
  theme(axis.line = element_line(colour = "black", size = .5),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "cm"))

cent_dist_plt
ggsave(cent_dist_plt, filename = here::here("output", "figures", "distance_to_centroids.svg"), device = "svg", width = 20, height = 18, units = "cm")

```

Those are interesting results. At week 0, all groups seem to be all over the place and none appear to be better clustered than others. However at week 24, the DTG group becomes more closer together, which is not observed in the DRV group. This may be suggesting the DTG group is entering a "healthy stable" state.

# Distances to basal

```{r First_differences, message = F, warning = F}

phy <- get_phyloseq(mymre, type = "metaphlan") 

otu_df <- 
  phyloseq::otu_table(phy) %>% 
  t() %>% 
  as.data.frame() %>% 
  stats::setNames(phyloseq::tax_table(phy)[,"Species"]) %>% 
  # tibble::rownames_to_column("SampleID") %>% 
  stats::setNames(.,stringr::str_remove_all(colnames(.), "\\[")) %>% 
  stats::setNames(.,stringr::str_remove_all(colnames(.), "\\]"))  



lmms <- 
otu_df %>% 
  vegan::vegdist(x = ., method = "bray") %>% 
  distance_from_basal(dist_mat = ., metadata = metadata, 
                      link_var = "record_id",
                      long_var = "time_point",
                      cat_var = "group",
                      basal = 0) 

lab <- lmms %>% 
  pluck("stat") %>% 
  names() %>% 
  set_names() %>% 
  map_dfr(~ {
    lmms %>% 
      purrr::pluck("stat",.x) %>% 
      as.data.frame() %>% 
      dplyr::select(Value, pval = `p-value`) %>% 
      dplyr::slice(2L) %>% 
        round(3) %>% 
      dplyr::mutate(group =.x)
})

plot <- 
  lmms %>% 
  pluck("plot")+
  scale_x_continuous(breaks = unique(metadata$time_point)) +
  scale_color_brewer(palette = "Accent") +
  scale_fill_brewer(palette = "Accent") 


plot
lab

```

Sample A0023 apparently jups to distance = 1 from the very start

# Pairwise distances evolution

It has been suggested the human microbiome follows the "Anna Karenina" principle which states: *"All happy families are alike; each unhappy family is unhappy in its own way."*. In microbiome it translates to healthy patients having somewhat similar microbiomes and when the immune system breaks down, the microbiome escapes a stable configuration and changes without any specific directin. Hence, in this setting, pairwise distances at basal should be higher and decrease as the immune system recomposes and the microbimes move towards a "healthy" composition which is more constant among patients.

```{r pairwise_distances_tp, warning=F, message=FALSE, eval = F}

samplenames <- myBrayDistMat %>% as.matrix ()%>% rownames()
centroids <-
vegan::betadisper(d = myBrayDistMat,
                           group = metadata %>% 
                             arrange(factor(SampleID, levels = rownames(as.matrix(myBrayDistMat)))) %>% 
                             pull(group),
                  type = "centroid") %>% plot() 
  dplyr::rename(SampleID = Item)

upper_distmat <- as.matrix(myBrayDistMat)
upper_distmat[lower.tri(upper_distmat)] <- NA
sample_vc <- metadata$time_point
names(sample_vc) <- metadata$SampleID

distance_df <- 
upper_distmat %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  # dplyr::filter(!rownames(.)==colnames(.)) %>%
  rownames_to_column("Sample1") %>% 
  pivot_longer(cols = !Sample1, names_to = "Sample2", values_to = "dist") %>% 

    mutate(tp1 = sample_vc[Sample1],
           tp2 = sample_vc[Sample2]) %>% 
    dplyr::filter(Sample1 != Sample2,
                  tp1 == tp2) 




distance_df %>% 
  # sample_n_by(cmv, size = 406) %>%
  ggstatsplot::ggbetweenstats(.,
                              x = "tp1",
                              y = "dist",
                              type = "np") +
  labs(y = "pairwise within-group distances",
       x = "week")


```

Looks like the hypotesis holds. Beta diversity drastically decreases from baseline to week 24 (medians 074 vs 0.66) and becomes somewhat consistent afterwards, decreasing very slowly as it only becomes relevant after 96 weeks. This suggests the microbiome makes ost of the recovery quickly after which it stabilizes, changling very slowly, if at all.

```{r first_dist_boxplots, warning= F, message=F}
first_dif <- 
  otu_df %>% 
  vegan::vegdist(x = ., method = "bray") %>% 
  distance_from_basal(dist_mat = ., metadata = metadata, 
                      link_var = "record_id",
                      long_var = "time_point",
                      cat_var = "group", basal= 0) %>% 
  pluck("data")

test_cat <-
  first_dif %>%
  dplyr::group_by(time_point) %>%
  rstatix::wilcox_test(distance ~ group, p.adjust.method = "BH") %>%
  # rstatix::adjust_pvalue(p.col = "p", method = "none") %>%
  rstatix::add_significance(p.col = "p", output.col = "p.adj.signif") %>%
  rstatix::add_xy_position("time_point") %>%
  dplyr::mutate(y.position = y.position + 0.2)





test_long <-
  first_dif %>%
  PairedWilcox_withNAs(
    myDF = .,
    IDs = "record_id",
    Variable = "distance",
    Response = "time_point",
    Subsets = "group"
  ) %>%
  group_by(group) %>%
  rstatix::adjust_pvalue(p.col = "p",
                         output.col = "p.adj",
                         method = "BH") %>%
  ungroup() %>%
  # rstatix::adjust_pvalue(method = "BH") %>%
  add_significance(p.col = "p.adj") %>%
  
  # mutate(CategoricalVariable = levels(as.factor(myInnerDataFrame$CategoricalVariable))) %>%
  # add_y_position(y.trans = function(x){quantile(x, probs=c(.1))}) %>%
  mutate(
    xmin = recode(
      group1,
      `24` = 1,
      `48` = 2
    ),
    xmax = recode(
      group2,
      `24` = 1,
      `48` = 2,
      `96` = 3
    )
  ) %>%
  mutate(xmin = case_when(group == "DTG" ~ xmin + 0.2,
                          group == "DRV/r" ~ xmin - 0.2),
         xmax = case_when(group == "DTG" ~ xmax + 0.2,
                          group == "DRV/r" ~ xmax - 0.2))



boxplots <- 
 
  ggplot(first_dif, aes(x = as.factor(time_point), y = distance)) +
  geom_boxplot(position = "dodge")+
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  stat_pvalue_manual(test_cat, label = "p.adj.signif", step.increase = .01, hide.ns = T) +
  stat_pvalue_manual(test_long, label = "p.adj.signif", step.increase = .02, hide.ns = T) +
  theme_bw() + 
  labs(x = "Weeks", y = "distance from basal") +
  scale_fill_brewer(palette = "Accent")


lmms

boxplots


```
