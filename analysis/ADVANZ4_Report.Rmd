---
title: "ADVANZ4 initial report"
author: "Carlos Bl√°zquez Bondia"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(metar)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(ggpubr)


```




```{r load_u_data_cars, eval=T, include=F}
myPath<-here::here()
setwd(myPath)
mymre<-readRDS("DataPackages/mre.rds")
metadata <- metar::get_metadata(mymre)
library(rstatix)



```

## ADVANZ-4 Initial report



```{r get_GeneRichness_Data, echo=FALSE, message=F, warning=F}
igc<-metar::get_diversity(mymre)@igc
Threshold = igc@dataTable %>%
  summarise(Thershold = quantile(NumberMappedReads,0.02)) %>%
  as.numeric()

ThresholdTable<-igc@dataTable %>%
  filter(NumberMappedReads >= quantile(NumberMappedReads,0.02)) %>%
  group_by(SampleID) %>%
  summarise(across(everything(), min)) %>%
  ungroup() %>%
  left_join(., metadata@metadata_df, by="SampleID")



nDroppedSamples<-length(unique(igc@dataTable$SampleID)) - length(ThresholdTable$SampleID)
  
```

The ADVANZ-4 study consisted on 95 patients, giving a total of 271 samples sequenced. Due to sequencing depth diferences, all samples were rarefied to the 2nd percentile, consisting on a minimum read count of 10.000.000. This resulted in 5 samples being dropped due to low read counts, leaving a total of 261 samples.


``` {r Plot_Rarefaction, echo=F, message=F, warning=F}
myRarefaction<-mymre@diversity@igc@rarefaction$categorical$Group$rarefaction +
  scale_color_manual(values = brewer.pal(n=2, name =  "Set1"), labels = c("ABC+3TC+DGT","ABC+3TC+DRV+RTV")) +

  geom_vline(xintercept = Threshold, color="black", inherit.aes = F) + 
  labs(subtitle = paste("Rarefaction Threshold: 2nd percentile (", as.numeric(Threshold),")",sep=""),
       color = "Group") +
  theme(plot.subtitle = element_text(size = 8),
        plot.title =  element_text(size=9, face="bold"))


DepthViolin<-igc@dataTable %>%
  left_join(., metadata@metadata_df[,c("SampleID","Treat", "TimePoint")]) %>%
  rename(CategoricalVariable = Treat,
         LongitudinalVariable = TimePoint) %>%
  group_by(SampleID) %>% 
  filter(ReadCountReal == max(ReadCountReal)) %>%
  
  
  ggplot(., aes(x=CategoricalVariable, y=ReadCountReal, Group = CategoricalVariable)) +
  geom_violin() +
  geom_boxplot(aes(fill=CategoricalVariable), width=0.4) + 
  ggpubr::stat_compare_means( method = "wilcox",label = "p.signif", label.x.npc = 0.5) +
  theme_bw() + 
  geom_hline(yintercept = Threshold) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Sequencing depth distribution by Group", subtitle = "Wilcoxon Test",
       x= "Group",
       fill="Group",
       y="Max sequencing depth") +
  theme(plot.subtitle = element_text(size = 8),
        plot.title =  element_text(size=9, face="bold"))

  

ggarrange(myRarefaction, DepthViolin, common.legend = T)


```


```{r taxa_functions, echo = F, warning=F, message = F}
taxa_barplot<-function(Phyloseq, 
                       Abundance_table=NULL,
                       Taxonomy_table=NULL, 
                       sample_var,metadata, 
                       tax_level, 
                       Nspecies,
                       idvar, 
                       facet_vars = NULL){
  require(phyloseq)
  require(reshape2)
  set.seed(1234)
  # Merge id and faceting variables to include in the plot
  VarsToChoose<-c(idvar,facet_vars)
  
  myInnerPhyloseq<-phyloseq::tax_glom(Phyloseq,taxrank = tax_level)

  Taxonomy_table<-phyloseq::tax_table(myInnerPhyloseq)
  Abundance_table<-as.data.frame(t(otu_table(myInnerPhyloseq))) %>%
    setNames(Taxonomy_table[,tax_level])
  # Get number of species 
  
  if(ncol(Abundance_table) < Nspecies){
    Nspecies <- ncol(Abundance_table)
  }
  
  TopNspecies<-as.vector(rownames(data.frame(sort(colSums(Abundance_table),decreasing=T)[0:Nspecies])))
  
  # Construct the inner data frame, cureate and melt
  myInnerDataFrame<- merge( metadata[,c(sample_var,VarsToChoose)]  %>%
                              column_to_rownames(var = sample_var),
                            Abundance_table[,TopNspecies], by = "row.names",all.y = F) %>%
    
    transform(.,row.names=Row.names, Row.names=NULL) %>%
    

    reshape2::melt(id.vars = c(VarsToChoose)) %>%
    
    dplyr::rename(Species = variable, 
                  Abundance = value,
                  id_var = paste(idvar)) %>%
    
    mutate(id_var = as.factor(id_var))
  
  
  
  # # Taxa Level stands for taxonomical number (1 = Kingdom to 7 = Species)
  # tax_name<- tax_level
  
  
  # Extract and mix palettes from ColorBrewer
  
  qpalettes<- brewer.pal.info[which(brewer.pal.info$category=="qual"),]
  color_vector <- unlist(mapply(brewer.pal, qpalettes$maxcolors, rownames(qpalettes)))
  
  # Create palette according to the number of species
  n<-length(unique(TopNspecies))
  
  if (n<length(color_vector)){
    palette<-sample(color_vector, n, replace = F)
  }else{
    palette<-sample(color_vector, n, replace = T)
  }
  
  
  
  # Build the faceting formula in case it was inputted
  if (!is.null(facet_vars)){
    facet_formula<-formula(paste(facet_vars[2],"~",facet_vars[1]))
    
  }else{facet_formula<-NULL}
  
  
  barplot<- ggplot(myInnerDataFrame, aes(x=id_var,y=Abundance, fill=Species)) + 
    geom_bar(aes(color=Species, fill=Species), stat="identity", position="stack")+
    facet_grid(facets =  facet_formula, scales="free_x", space= "free",drop = TRUE)+
    theme_bw()+
    theme(axis.text.x = element_text(size=8,angle = 90 )) +
    scale_discrete_manual(aesthetics=c("color","fill"),values=palette) + 
    # guides(fill=guide_legend(nrow=80, byrow=TRUE), col=guide_legend(nrow=40,byrow=TRUE)) + 
    labs(title = paste ("Abundance plot for top", Nspecies,tax_level, sep=" "), x= paste(idvar))
  
  
  return(barplot)
}

myPhyloseq<-mymre@taxa@metaphlan@phyloseq



```



At the phylum level, no apparent trend of change could be observed, bar a probable slight decrease in proteobacteria over time in both groups, although any conclusion drawn from these figures should be met with caution. No aparent change trends can be seen either between groups or longitudinally when looking at the genus and species level.


```{r Taxa_Boxplots_Phyl, echo = F, warning=F, message=F}

myTaxaBarplotPhyl<-taxa_barplot(myPhyloseq, metadata = metadata@metadata_df, 
             tax_level = "Phylum",
             idvar = metadata@longitudinal_vals$LinkVariable,
             facet_vars = c("Treat", metadata@longitudinal_vals$LongitudinalVariable),
             sample_var = "SampleID",
             Nspecies = 30) + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal")


myTaxaBarplotPhyl
```

```{r Taxa_Boxplots_Gen, echo = F, warning=F, message=F}

myTaxaBarplotGen<-taxa_barplot(myPhyloseq, metadata = metadata@metadata_df, 
             tax_level = "Genus",
             idvar = metadata@longitudinal_vals$LinkVariable,
             facet_vars = c("Treat", metadata@longitudinal_vals$LongitudinalVariable),
             sample_var = "SampleID",
             Nspecies = 30) + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal")

myTaxaBarplotSp<-taxa_barplot(myPhyloseq, metadata = metadata@metadata_df, 
             tax_level = "Species",
             idvar = metadata@longitudinal_vals$LinkVariable,
             facet_vars = c("Treat", metadata@longitudinal_vals$LongitudinalVariable),
             sample_var = "SampleID",
             Nspecies = 30) + 
  theme(legend.position = "bottom",
        legend.direction = "horizontal")


myTaxaBarplotGen +
  theme(legend.key.size = unit(0.3, "cm"),
        legend.text = element_text(size=5),
        axis.text.x = element_text(size=7))

myTaxaBarplotSp +
  theme(legend.key.size = unit(0.3, "cm"),
        legend.text = element_text(size=5),
        axis.text.x = element_text(size=7))

```

