---
title: "Data Preprocessing"
author: "Marc Noguera"
date: "2/25/2022"
output: html_document
---

```{r setup, include=FALSE,eval=F}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Read Data and Create metar object
```{r readMetadata ,echo=F,include=F,message=F}
suppressMessages(require(DataExplorer))
suppressMessages(require(phyloseq))
suppressMessages(require(ggstatsplot))
suppressMessages(require(ggplot2))
suppressMessages(require(here))
suppressMessages(require(knitr))
# Load package from local copy


### Project variables
bucket<-"s3://mistral-wp6-advanz4/"
bucketDir<-"metagenome/WMGS"


### Load data and create MRE Object
devtools::load_all("~/Documents/Work/Development/WMGSPipeline/")### Change to require/library/load local package
#### Create MRE object, needs environment-defined AWS credentials, see aws.s3
myMREObject<-metar::metarExperiment_aws(paste0(bucket,bucketDir))



### Ensure Metadata Correctness and coherence among phyloseq objects and metadata slots before proceeding.

if ( ! identical(myMREObject@metadata@metadata_df,myMREObject@taxa@metaphlan@phyloseq@sam_data)){
  rlog::log_warn("Sample Data from mre and phyloseq do not overlap...correcting")
  myDF<-as.data.frame(myMREObject@metadata@metadata_df)
  rownames(myDF)<-myDF$SampleID
  sample_data(myMREObject@taxa@metaphlan@phyloseq)<-myDF
  sample_data(myMREObject@taxa@metaphlan@phyloseq_sec)<-myDF
}else{
  rlog::log_info("Phyloseq metadata and mre metadata are consistent. Moving on.")
}

if ( ! identical(myMREObject@metadata@metadata_df,myMREObject@taxa@motus@phyloseq@sam_data)){
  rlog::log_warn("Sample Data from mre and phyloseq do not overlap...correcting")
  myDF<-as.data.frame(myMREObject@metadata@metadata_df)
  rownames(myDF)<-myDF$SampleID
  sample_data(myMREObject@taxa@motus@phyloseq)<-myDF
  # sample_data(myMREObject@taxa@motus@phyloseq_sec)<-myDF #Set whenever we have counts for motusV2
}else{
  rlog::log_info("Phyloseq metadata and mre metadata are consistent. Moving on.")
}

myMREObject@wd<-"output/mre_data/"
dir.create("data/processed/")
saveRDS(myMREObject,"data/processed/mreObject.rds")
aws.s3::s3saveRDS(myMREObject,bucket=bucket,object = paste0(bucketDir,"/MREObject.rds"))



```

```{r metar object characteristics}
myMREObject
```
